# éœ€æ±‚åˆ†æ

# yapi

## linuxå®‰è£…yapi

[å®˜æ–¹åœ°å€](https://github.com/jinfeijie/yapi)

### è·å–æœ¬é•œåƒ

ğŸš˜è·å–æœ¬é•œåƒï¼š`docker pull mrjin/yapi:latest`

### docker-compose éƒ¨ç½²

```
version: '2.1'
services:
  yapi:
    image: mrjin/yapi:latest
    # build: ./
    container_name: yapi
    environment:
      - VERSION=1.9.3
      - LOG_PATH=/tmp/yapi.log
      - HOME=/home
      - PORT=3000
      - ADMIN_EMAIL=test@test.com
      - DB_SERVER=mongo
      - DB_NAME=yapi
      - DB_PORT=27017
    # restart: always
    ports:
      - 127.0.0.1:3000:3000
    volumes:
      - ~/data/yapi/log/yapi.log:/home/vendors/log # log dir
    depends_on:
      - mongo
    entrypoint: "bash /wait-for-it.sh mongo:27017 -- entrypoint.sh"
    networks:
      - back-net
  mongo:
    image: mongo
    container_name: mongo
    # restart: always
    ports:
      - 127.0.0.1:27017:27017
    volumes:
      - ~/data/yapi/mongodb:/data/db #db dir
    networks:
      - back-net
networks:
  back-net:
    external: true
```

### Nginx é…ç½®

```
server {
    listen     80;
    server_name your.domain;
    keepalive_timeout   70;

    location / {
        proxy_pass http://yapi:3000;
    }
    location ~ /\. {
        deny all;
    }
}
```

### å¯åŠ¨æ–¹æ³•

1. ä¿®æ”¹`docker-compose.yml`æ–‡ä»¶é‡Œé¢ç›¸å…³å‚æ•°
2. åˆ›å»ºnetworkï¼š`docker network create back-net`
3. å¯åŠ¨æœåŠ¡ï¼š`docker-compose up -d`

# gorm

## ä»€ä¹ˆæ˜¯orm

â€‹	ORMå…¨ç§°æ˜¯:**Object Relational Mapping**(å¯¹è±¡å…³ç³»æ˜ å°„)ï¼Œå…·ä½“ä½œç”¨æ˜¯åœ¨ç¼–ç¨‹æ—¶ï¼ŒæŠŠé¢å‘å¯¹è±¡çš„æ¦‚å¿µè·Ÿæ•°æ®åº“ä¸­è¡¨çš„æ¦‚å¿µå¯¹åº”èµ·æ¥ã€‚ä¸¾ä¾‹æ¥è¯´å°±æ˜¯ï¼Œæˆ‘å®šä¹‰ä¸€ä¸ªå¯¹è±¡ï¼Œé‚£å°±å¯¹åº”ç€ä¸€å¼ è¡¨ï¼Œè¿™ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼Œå°±å¯¹åº”ç€è¡¨ä¸­
çš„ä¸€æ¡è®°å½•ã€‚

â€‹	å¯¹äºæ•°æ®æ¥è¯´ï¼Œæœ€é‡è¦å’Œå¸¸ç”¨çš„æ˜¯è¡¨ï¼šè¡¨ä¸­æœ‰åˆ—ï¼Œormå°±æ˜¯å°†ä¸€å¼ è¡¨æ˜ å°„æˆä¸€ä¸ªç±»ï¼Œè¡¨ç”¨çš„åˆ—æ˜ å°„æˆç±»ä¸­çš„ç±»ï¼ˆJavaï¼Œpythonï¼‰

â€‹	ä½†æ˜¯é’ˆå¯¹goè¯­è¨€è€Œè¨€ï¼Œstructå¦‚ä½•æ˜ å°„åˆ—ï¼Ÿå…¶å®åˆ—çš„å±æ€§å°±å¯¹åº”äº†structçš„å±æ€§ï¼ˆint->intï¼‰ï¼Œè¿˜æœ‰ï¼Œæ•°æ®åº“ä¸­çš„åˆ—å…·å¤‡è‰¯å¥½çš„æè¿°æ€§ï¼ˆä¸»é”®ï¼Œå¤–é”®ï¼‰ï¼Œstructä¸­çš„tagä¹Ÿå¯ä»¥å®ç°è¿™ä¸€ç‚¹

â€‹	æ‰§è¡Œsqlï¼Œéœ€è¦æˆ‘ä»¬æœ‰è¶³å¤Ÿçš„sqlè¯­å¥åŸºç¡€ï¼Œéœ€è¦æˆ‘ä»¬æ‡‚å¾—ä¸åŒçš„æ•°æ®çš„sql

## å¸¸ç”¨çš„orm

https://github.com/go-gorm/gorm

https://github.com/facebook/enthttps://github.com/jmoiron/sqlx

https://gitea.com/xorm/xorm/src/branch/master/README_CN.md

https://github.com/didi/gendry/blob/master/translation/zhcn/README.md

## ormä¼˜ç¼ºç‚¹

- ä¼˜ç‚¹:
  1.æé«˜äº†å¼€å‘æ•ˆç‡ã€‚

  2.å±è”½sqlç»†èŠ‚ã€‚å¯ä»¥è‡ªåŠ¨å¯¹å®ä½“Entityå¯¹è±¡ä¸æ•°æ®åº“ä¸­çš„Tableè¿›è¡Œå­—æ®µä¸å±æ€§çš„æ˜ å°„;ä¸ç”¨ç›´æ¥SQLç¼–ç 

  3.å±è”½å„ç§æ•°æ®åº“ä¹‹é—´çš„å·®å¼‚

- ç¼ºç‚¹:

  1.gormä¼šç‰ºç‰²ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡å’Œä¼šå›ºå®šæ€ç»´æ¨¡å¼

  2.å¤ªè¿‡ä¾èµ–ormä¼šå¯¼è‡´sqlç†è§£ä¸å¤Ÿ

  3.å¯¹äºå›ºå®šçš„ormä¾èµ–è¿‡é‡ï¼Œå¯¼è‡´åˆ‡æ¢åˆ°å…¶ä»–çš„ormä»£ä»·é«˜

## å¦‚ä½•æ­£ç¡®çœ‹å¾…ormå’Œsqlä¹‹é—´çš„å…³ç³»

1. sqlä¸ºä¸»ï¼Œormä¸ºè¾…
2. ormä¸»è¦æ˜¯ä¸ºäº†å¢åŠ ä»£ç å¯ç»´æŠ¤æ€§å’Œå¼€å‘æ•ˆç‡

## gormå®è·µ

[å®˜æ–¹æ–‡æ¡£](https://gorm.io/docs/index.html)

[å®è·µæ–‡æ¡£](https://www.yuque.com/flare-gcgmb/hpm2qa)

# gin

## è·¯ç”±åŒ¹é…

handler

```go
func GetUserNameRedirect(c *gin.Context) {
	//ä»urlä¸­åŒ¹é…å‚æ•°
	name := c.Param("name")
	action := c.Param("action")
	message := name + " is " + action
	c.String(http.StatusOK, message)
}

func PostUserName(c *gin.Context){
	//è·å–pathæ•°æ®
	b := c.FullPath() == "/user/:name/*action" // true
	c.String(http.StatusOK, "%t, FullPath=%s", b, c.FullPath())
}

// GetJSON http://localhost:8008/json
func GetJSON(c *gin.Context){
	//gin.Hæ˜¯åˆ›å»ºmap[string]interface{}çš„å¿«æ·æ–¹å¼
	//è¿”å›json
	c.JSON(http.StatusOK, gin.H{
		"message":"Ghost",
	})
}

// Hello http://localhost:8008/hello?f=roger&l=federer
func Hello(c *gin.Context){
	//ä»url paramä¸­è·å–å‚æ•°
	firstName := c.DefaultQuery("f","guest")
	lastName := c.Query("l")
	//è¿”å›æ–‡æœ¬
	c.String(http.StatusOK,"Hello, %s %s", firstName, lastName)
}

// PostMes http://localhost:8008/mes
func PostMes(c *gin.Context) {
	//ä»Multipart/Urlencoded Formè·å–æ•°æ®
	message := c.PostForm("message")
	name := c.DefaultPostForm("name", "anonymous")
	c.JSON(http.StatusOK, gin.H{
		"status": "POSTED",
		"message": message ,
		"name": name,
	})
}

func PostFromMap(c *gin.Context) {
	//è·å–è·¯å¾„paramsçš„mapï¼Œè¡¨å•çš„map
	ids := c.QueryMap("ids")
	names := c.PostFormMap("names")
	log.Printf("ids=%v, names=%v", ids, names)
}

func PostMulQuery(c *gin.Context) {
	//è·å–è·¯å¾„paramså‚æ•°ï¼Œbodyçš„è¡¨å•å‚æ•°
	id := c.Query("id")
	page := c.DefaultQuery("page", "0")
	name := c.DefaultPostForm("name", "anonymous")
	hobby := c.PostForm("hobby")
	log.Printf("id=%v,page=%v,name=%v,hobby=%v",id,page,name,hobby)
	c.JSON(http.StatusOK, gin.H{
		"id":id,
		"page":page,
		"name":name,
		"hobby":hobby,
	})
}
```

main

```go
func main(){
	// æ— ä¸­é—´ä»¶å¯åŠ¨
	//router := gin.New()
	// é»˜è®¤å¯åŠ¨æ–¹å¼ï¼ŒåŒ…å« Loggerã€Recovery ä¸­é—´ä»¶
	router := gin.Default()
	//urlè¦å”¯ä¸€
	router.GET("/json", GetJSON)
	router.GET("/hello", Hello)
	router.POST("/mes", PostMes)
	router.POST("/user/:name/*action", PostUserName)
	router.GET("/user:name/*action", GetUserNameRedirect)
	router.POST("/mul_query", PostMulQuery)
	router.POST("/form_map", PostFromMap)

	router.Run(":8008")
}
```

## è·¯ç”±åˆ†ç»„

```go
	//è·¯ç”±åˆ†ç»„
	userGroup := router.Group("/user")
	{
		userGroup.POST(":name/*action", PostUserName)
		userGroup.GET(":name/*action", GetUserNameRedirect)
	}
```

## è¡¨å•éªŒè¯

main

```go
	//ç™»å½•è¡¨å•éªŒè¯
	router.POST("/loginJSON", PostLogin)
	//æ³¨å†Œè¡¨å•éªŒè¯
	router.POST("/signUpJSON", PostSignUp)
```

handler

```go

type LoginForm struct {
	Username string `json:"username" binding:"required,min=3,max=10"`
	Password string `json:"password" binding:"required"`
}

type SignUpForm struct {
	Age        uint8  `json:"age" binding:"gte=1,lte=130"`
	Name       string `json:"name" binding:"required,min=3"`
	Email      string `json:"email" binding:"required,email"`
	Password   string `json:"password" binding:"required"`
	RePassword string `json:"re_password" binding:"required"`
}

func PostLogin(c *gin.Context) {
	var loginForm LoginForm
	if err := c.ShouldBind(&loginForm); err != nil {
		fmt.Println(err.Error())
		c.JSON(http.StatusBadRequest, gin.H{
			"error": err.Error(),
		})
		return
	}
	c.JSON(http.StatusOK, gin.H{
		"msg": "ç™»å½•æˆåŠŸ",
	})
}

func PostSignUp(c *gin.Context) {
	var signUpForm SignUpForm
	if err := c.ShouldBind(&signUpForm); err != nil {
		fmt.Println(err.Error())
		c.JSON(http.StatusBadRequest, gin.H{
			"error": err.Error(),
		})
		return
	}
	c.JSON(http.StatusOK, gin.H{
		"msg": "æ³¨å†ŒæˆåŠŸ",
	})
}
```

## ç¿»è¯‘å™¨

ç¿»è¯‘å¼•æ“+è·å–tagä¸ºjson+keyæˆªå–

utils

```go

func GetTrans() ut.Translator{
	return trans
}

//å»é™¤jsoné”®ä¸­çš„ç»“æ„ä½“å¤´éƒ¨
func RemoveTopStruct(fields map[string]string) map[string]string{
	rsp := make(map[string]string)
	for field ,err := range fields{
		rsp[field[strings.Index(field,".")+1:]] = err
	}
	return rsp
}

func InitTranslate(locate string)(err error){
	//	ä¿®æ”¹ginä¸­çš„validatorå¼•æ“å±æ€§ï¼Œå®ç°å®šåˆ¶
	if v, ok := binding.Validator.Engine().(*validator.Validate); ok{
		//æ³¨å†Œä¸€ä¸ªè·å– tagä¸ºjson çš„è‡ªå®šä¹‰æ–¹æ³•
		v.RegisterTagNameFunc(func(fld reflect.StructField) string{
			name := strings.SplitN(fld.Tag.Get("json"), ".",2)[0]
			if name == "-"{//ç‰¹æ®Šå­—ç¬¦ï¼Œä¸å¤„ç†
				return ""
			}
			return name
		})

		//ç¿»è¯‘å™¨å®ä¾‹
		zhT := zh.New()//ç¿»è¯‘ä¸­æ–‡
		enT := en.New()//ç¿»è¯‘è‹±æ–‡
		//	ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å¤‡ç”¨çš„è¯­è¨€ç¯å¢ƒï¼Œåé¢çš„å‚æ•°åº”è¯¥æ”¯æŒçš„è¯­è¨€ç¯å¢ƒ
		uni := ut.New(zhT, zhT, enT)
		trans, ok = uni.GetTranslator(locate)
		if !ok{
			log.Fatalf("uni.GetTranslator : %v", err)
		}
		switch locate {
		case "zh":
			en2.RegisterDefaultTranslations(v, trans)
		default:
			zh2.RegisterDefaultTranslations(v, trans)
		}
		return
	}
	return
}
```



## ä¸­é—´ä»¶

```go
//ä¸­é—´ä»¶æ‰“å°è€—æ—¶
func MyLogger() gin.HandlerFunc{
	return func(c *gin.Context){
		start := time.Now()
		c.Set("example","123")
		//	è®©åŸæœ¬è¯¥æ‰§è¡Œçš„é€»è¾‘ç»§ç»­æ‰§è¡Œ
		c.Next()
		sub := time.Since(start)
		fmt.Printf("è€—æ—¶ï¼š%v\n", sub)
		status := c.Writer.Status()
		fmt.Printf("çŠ¶æ€ï¼š%v\n", status)
	}
}

func main(){
	router := gin.New()
	router.Use(MyLogger())
	router.GET("/ping", func(c *gin.Context){
		c.JSON(http.StatusOK, gin.H{
			"msg": "Pong",
		})
	})
	router.Run(":8874")
}
```

![image-20220303160150877](http://myimg.go2flare.xyz/img/image-20220303160150877.png)

```go
//myloggerä¸Šé¢æœ‰
//æŸæ®µä»£ç éœ€è¦ç™»å½•åæ‰èƒ½æ‰§è¡Œï¼Œæ¯”å¦‚è¯´é‰´æƒåå‘æ”¾token
func TokenRequired() gin.HandlerFunc{
	return func(c *gin.Context){
		var token string
		for k,v := range c.Request.Header{
			//è¿™é‡Œheaderæœ‰æ³¨æ„ç‚¹ï¼Œå°±ç®—æ˜¯è¯·æ±‚çš„headerä¸­ä¸ºtokençš„keyï¼Œä½†æ˜¯è¿˜æ˜¯æ— æ³•åŒ¹é…
			//å› ä¸ºå‘é€è¯·æ±‚åï¼Œæ¥æ”¶çš„headerä¸ºé¦–å­—æ¯å¤§å†™
			if k == "X-Token"{
				token = v[0]
			}
		}
		if token != "test"{
			c.JSON(http.StatusUnauthorized, gin.H{
				"msg":"æœªç™»å½•",
			})
			//ä¸­é—´ä»¶åç»­é€»è¾‘éƒ½ä¸æ‰§è¡Œ
			c.Abort()
		}
		c.Next()
	}
}

func main(){
	router := gin.New()
	//ä¸­é—´ä»¶ï¼šè€—æ—¶æ‰“å°ï¼Œtest1-3åŸç†ç†è§£ï¼Œtokenæ¨¡æ‹Ÿ
	router.Use(TokenRequired(), MyLogger())
	router.GET("/ping", func(c *gin.Context){
		fmt.Println("æ“ä½œé€»è¾‘")
		c.JSON(http.StatusOK, gin.H{
			"msg": "Pong",
		})
	})
	router.Run(":8874")
}
```



## æ—¶é—´æ ¼å¼åŒ–

```go
	//è·å–åˆ—è¡¨
	for _, value := range rsp.Data {
		user := reponse.UserResponse{
			Id:       value.Id,
			NickName: value.NickName,
			//Birthday: time.Time(time.Unix(int64(value.BirthDay), 0)).Format("2006-01-02"),//è‡ªå·±è½¬æ¢stringæ ¼å¼ä¸ºtime
			Birthday: reponse.JsonTime(time.Unix(int64(value.BirthDay), 0)),
			Gender:   value.Gender,
			Mobile:   value.Mobile,
		}
		result = append(result, user)
	}
```

```go
type JsonTime time.Time

// MarshalJSON ç”¨timeçš„åŒç±»å‹å®ç° Marshaleræ¥å£ï¼Œè½¬jsonæ—¶ä¼šè‡ªåŠ¨ä½¿ç”¨è¯¥æ¥å£çš„æ–¹æ³•
func (j JsonTime) MarshalJSON() ([]byte, error) {
	//æ ¼å¼åŒ–æ—¶é—´
	var stmp = fmt.Sprintf("\"%s\"", time.Time(j).Format("2006-01-02 15:04:05"))
	return []byte(stmp), nil
}

type UserResponse struct {
	Id       int32  `json:"id"`
	NickName string `json:"name"`
	//Birthday string `json:"birthday"`//æˆ‘ä»¬åªéœ€è¦ç”¨ç»“æ„ä½“æ¥æ”¶jsonçš„ä¿¡æ¯ï¼Œä¸ç”¨ä½¿ç”¨ï¼Œæ‰€ä»¥èƒ½è§£æä¸ºéstringçš„timeæ›´å¥½
	//ï¼Œä½†è½¬æˆæŒ‡å®šæ ¼å¼å¾—å®ç°æ¥å£
	Birthday JsonTime `json:"birthday"`
	Gender   string   `json:"gender"`
	Mobile   string   `json:"mobile"`
}
```



# æ³¨å†Œä¸­å¿ƒ

## consul

ä½¿ç”¨consulä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé…åˆmicroV2æ¡†æ¶

æœåŠ¡å‘ç°:å¾®æœåŠ¡å¼€å‘ä¸­çš„æ ¸å¿ƒæŠ€æœ¯ï¼ˆä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæœåŠ¡ï¼‰

### serverï¼Œclientæµç¨‹

- â€‹	æ¯ä¸ªserverå¯åŠ¨æ—¶ï¼Œå°†è‡ªå·±çš„ipï¼Œportå’ŒæœåŠ¡åæ³¨å†Œç»™æœåŠ¡å‘ç°

- â€‹	å½“clientå‘æœåŠ¡å‘ç°å‘èµ·æœåŠ¡è¯·æ±‚æ—¶ï¼Œâ€œæœåŠ¡å‘ç°"ä¼šè‡ªåŠ¨æ‰¾ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡ï¼Œå°†å…¶IP/port/æœåŠ¡åè¿”å›ç»™client
- â€‹	clientå†å€ŸåŠ©æœåŠ¡å‘ç°,è®¿é—®server

- å½“clientå‘æœåŠ¡å‘ç°å‘èµ·æœåŠ¡è¯·æ±‚æ—¶ï¼Œâ€œæœåŠ¡å‘ç°"ä¼šè‡ªåŠ¨æ‰¾ä¸€ä¸ªå¯ç”¨çš„æœåŠ¡ï¼Œå°†å…¶IP/port/æœåŠ¡åè¿”å›ç»™client

- clientå†å€ŸåŠ©æœåŠ¡å‘ç°,è®¿é—®server

### æ³¨å†Œä¸­å¿ƒç§ç±»

- consul
  å¸¸ç”¨äºgo-micro
  **ç‰¹ç‚¹**ï¼š
  	æœåŠ¡å‘ç°:æœåŠ¡ç«¯ä¸»åŠ¨å‘consulæ³¨å†Œ
  	å¥åº·æ£€æŸ¥:å®šæ—¶å‘æ¶ˆæ¯ï¼Œç±»ä¼¼â€œå¿ƒè·³â€ï¼Œä¿è¯å®¢æˆ·ç«¯è·å¾—çš„æœåŠ¡æ˜¯å¥åº·çš„
  	é”®/å€¼å­˜å‚¨:ä¸€èˆ¬ç”¨redis
  	å¤šæ•°æ®ä¸­å¿ƒ:è½»æ¾æ­å»ºé›†ç¾¤
- mdns
  		go-microé»˜è®¤è‡ªå¸¦
- etcd
  		k8så†…ç½®çš„æœåŠ¡å‘ç°
- zookeeper
  		javaä¸­å¸¸ç”¨

3. linuxå®‰è£…

   [ä¸‹è½½åœ°å€](https://releases.hashicorp.com/consul/)
   ä¸Šä¼ åˆ°linuxï¼Œunzipå‘½ä»¤
   ç§»åŠ¨åˆ°å®‰è£…ç›®å½•

   ```
   sudo mv usr/local/bin
   ```

4. å‘½ä»¤

   ```
   	-bind=0.0.0.0 æŒ‡å®šconsulæ‰€åœ¨æœºå™¨åœ°å€ï¼ˆé»˜è®¤ï¼‰
   	-http-port=8500 è‡ªå¸¦ç«¯å£
   	-client=127.0.0.1å“ªäº›æœºå™¨å¯ä»¥è®¿é—®consul
   	-config-dir=fooæ‰€æœ‰ä¸»åŠ¨æ³¨å†ŒæœåŠ¡çš„æè¿°ä¿¡æ¯
   	-data-dir=pathå‚¨å­˜æ‰€æœ‰æ³¨å†Œè¿‡æ¥çš„srvæœºå™¨çš„è¯¦ç»†ä¿¡æ¯ã€‚-dev
   	å¼€å‘è€…æ¨¡å¼ï¼Œç›´æ¥ä»¥é»˜è®¤é…ç½®å¯åŠ¨consul
   	-node=hostnameæœåŠ¡å‘ç°çš„åå­—ã€‚
   	-rejoin consulå¯åŠ¨çš„æ—¶å€™ï¼ŒåŠ å…¥åˆ°çš„consulé›†ç¾¤
   	-server ä»¥æœåŠ¡æ–¹å¼å¼€å¯consulï¼Œå…è®¸å…¶ä»–çš„consulè¿æ¥åˆ°å¼€å¯çš„consulä¸Š(å½¢æˆé›†ç¾¤)ã€‚å¦‚æœä¸åŠ -serverï¼Œè¡¨ç¤ºä»¥â€œå®¢æˆ·ç«¯â€çš„æ–¹å¼å¼€å¯ã€‚ä¸èƒ½è¢«è¿æ¥ã€‚
   	-ui å¯ä»¥ä½¿ç”¨webé¡µé¢æ¥æŸ¥çœ‹æœåŠ¡å‘ç°çš„è¯¦æƒ…
   ```

5. æµ‹è¯•

   serveræ¨¡å¼å¯åŠ¨

   ```
   consul agent -server -bootstrap-expect 1 -data-dir /tmp/consul -node=n1 -bind=172.29.113.151 -ui -rejoin -config-dir=/etc/consul.d/ -client 0.0.0.0
   ```

   ![image-20220301173758531](http://myimg.go2flare.xyz/img/image-20220301173758531.png)

   	é€šè¿‡æ ‡å¿—
   		==> Consul agent running!


### demoæ¶æ„

![image-20220301165630840](http://myimg.go2flare.xyz/img/image-20220301165630840.png)

## etcd

### ç®€ä»‹

ETCD æ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„åˆ†å¸ƒå¼é”®å€¼æ•°æ®åº“ï¼Œå¯ç”¨äºæœåŠ¡å‘ç°ã€‚ETCD é‡‡ç”¨ raft ä¸€è‡´æ€§ç®—æ³•ï¼ŒåŸºäº Go è¯­è¨€å®ç°ã€‚

### **ç‰¹ç‚¹**

ç®€å•ï¼šå®‰è£…é…ç½®ä½¿ç”¨ç®€å•ï¼Œæä¾› HTTP API

å®‰å…¨ï¼šæ”¯æŒ SSL è¯ä¹¦

å¯é ï¼šé‡‡ç”¨ raft ç®—æ³•ï¼Œå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæ•°æ®çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§

### å®‰è£…

å› ä¸ºæ˜¯goè¯­è¨€ç¼–å†™ï¼Œä½ å®Œå…¨å¯ä»¥ä»GitHubè·å–æ•´ä¸ªé¡¹ç›®å¹¶ç¼–è¯‘å‡ºå¯æ‰§è¡Œæ–‡ä»¶ï¼š[github](https://github.com/etcd-io/etcd)

ä¹Ÿå¯ä»¥ç›´æ¥ä»Githubä¸Šä¸‹è½½ä»–çš„æœ€æ–°ç‰ˆå¯æ‰§è¡Œæ–‡ä»¶ï¼š[etcd v3.4.13](https://github.com/etcd-io/etcd/releases/tag/v3.4.13)

å¦‚æœä½ æ‰“ç®—åœ¨Linuxæˆ–macç¯å¢ƒä¸‹ä½¿ç”¨dockerç®¡ç†ä»–ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å®˜æ–¹æŒ‡å¼•ç¼–å†™dockerfile

### linux

1.git clone

```bash
cd ~
sudo apt install -y git 
git clone https://github.com/etcd-io/etcd.git   

```

2.å®‰è£…

```bash
cd ~/etcd
go mod tidy
go mod verify
go mod download
go mod vendor
./build
cd bin 
sudo cp * /bin/
```

3.æµ‹è¯•

> è·å–å¸®åŠ©ï¼šetcd --help æˆ–è€… etcd -h

4.å•æœºå¯åŠ¨etcd v3

```bash
#æ•°æ®ç›®å½•åƒä¸‡ä¸è¦åˆ›å»º

mkdir -p ~/workspace/etcd/data.etcd/

rm -rf  ~/workspace/etcd/

æ—¥å¿—ç›®å½•

rm -rf ~/workspace/etcd/log/
mkdir -p ~/workspace/etcd/log/
```

```
etcd --data-dir ~/workspace/etcd/data.etcd/ --listen-client-urls http://127.0.0.1:2379 --advertise-client-urls http://127.0.0.1:2379 & >~/workspace/etcd/log/etcd.log
```

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20200504011144383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjM2NjM3OA==,size_16,color_FFFFFF,t_70)

æ–°å¼€ç»ˆç«¯etcdctlå‘½ä»¤ æŸ¥çœ‹

```bash
etcdctl --endpoints 127.0.0.1:2379 endpoint status --write-out="table"

æˆ–è€…ä½¿ç”¨

ETCDCTL_API=3 etcdctl --endpoints 127.0.0.1:2379 endpoint status --write-out="table"
```

æ–°å¼€ç»ˆç«¯æŸ¥çœ‹ç›®å‰çš„æ•°æ®ä¿¡æ¯

```
strings ~/workspace/etcd/data.etcd/member/wal/*.wal
```

### å®ä¾‹

## consul,etcdä¸microV2å®ä¾‹

- å¼€å¯consul, etcdæ³¨å†Œä¸­å¿ƒ

```
consul agent -dev
etcd
```

- micro new test
- service

```go
package main

import (
	"github.com/micro/go-micro/v2"
	log "github.com/micro/go-micro/v2/logger"
	"github.com/micro/go-micro/v2/registry"
	"github.com/micro/go-micro/v2/registry/etcd"
	_ "github.com/micro/go-plugins/registry/consul/v2"
	"testSrv/handler"
	"testSrv/proto/testSrv"
)

func main() {
	//æ’ä»¶ä¸­æ³¨å†Œconsulçš„æ¥å£
	//reg := consul.NewRegistry()
	//æ’ä»¶ä¸­æ³¨å†Œetcdçš„æ¥å£
	reg := etcd.NewRegistry(
		registry.Addrs("http://127.0.0.1:2379"),
		)
	//é…ç½®æœåŠ¡ä¿¡æ¯
	service := micro.NewService(
		micro.Name("testSrv"),
		micro.Registry(reg),
		micro.Version("latest"),
		micro.Metadata(map[string]string{"protocol" : "http"}),
	)

	// åˆå§‹åŒ–æœåŠ¡
	service.Init()

	// æœåŠ¡çš„å¤„ç†é€»è¾‘
	testSrv.RegisterTestSrvHandler(service.Server(), new(handler.TestSrv))

	//Register Struct as Subscriber
	//micro.RegisterSubscriber("go.micro.service.testSrv", service.Server(), new(subscriber.TestSrv))

	// è¿è¡Œ
	if err := service.Run(); err != nil {
		log.Fatal(err)
	}
}

```

-  web

```go
//åˆå§‹åŒ–micro
func InitMicro() client.Client{
	//æ’ä»¶ä¸­æ³¨å†Œconsulçš„æ¥å£
	//reg:=consul.NewRegistry()

	//æ’ä»¶ä¸­æ³¨å†Œetcdçš„æ¥å£
	reg := etcd.NewRegistry(
		registry.Addrs("http://127.0.0.1:2379"),
	)

	//é…ç½®æ³¨å†Œconsulçš„æ¥å£è·å–æœåŠ¡ä¿¡æ¯
	service := micro.NewService(
		micro.Registry(reg),
		micro.Metadata(map[string]string{"protocol" : "http"}),//å®¢æˆ·ç«¯æŠ¥é”™
	)
	//è¿”å›æœåŠ¡çš„clientï¼Œè°ƒç”¨service
	return service.Client()
}

func main(){
	serviceClient := InitMicro()

	//ä½¿ç”¨clientè·å–æŒ‡å®šæœåŠ¡ï¼Œè¿”å›æœåŠ¡çš„æ¥å£
	testSrvService := testSrv.NewTestSrvService("testSrv", serviceClient)

	//requestçš„ä¿¡æ¯
	role := testSrv.Character{
		Name: "Programmer",
		Work: "Typing Code",
	}
	rsp,err := testSrvService.Hello(context.TODO(), &testSrv.Request{Name:"Johnson",Age: 33, Role: &role})

	if err != nil {
		log.Fatalf("client.Hello err : %v", err)
	}
	fmt.Println(rsp.Msg)
}
```

### è¿™é‡Œæ³¨æ„ï¼Œmicroé»˜è®¤çš„mDNSæ³¨å†Œä¸­å¿ƒï¼Œæœ¬æœºæ— æ³•ä½¿ç”¨

```
{"id":"go.micro.client","code":500,"detail":"service testSrv: not found","status":"Internal Server Error"}
```

è¯¥é—®é¢˜åœ¨githubç­‰è¿˜æœªè§£å†³ï¼Œåº”è¯¥è·Ÿç¯å¢ƒç›¸å…³

## nacos

ä¸€èˆ¬ç”¨ä½œé…ç½®ä¸­å¿ƒ