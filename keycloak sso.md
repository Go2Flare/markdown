# å‰è¨€

Keycloak æ˜¯ä¸€ä¸ªä¼˜ç§€çš„**å¼€æºèº«ä»½ä¸è®¿é—®ç®¡ç†**ç³»ç»Ÿï¼Œæ—¨åœ¨ä¸ºç°ä»£çš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡æä¾›åŒ…å«**èº«ä»½ç®¡ç†å’Œè®¿é—®ç®¡ç†**åŠŸèƒ½ã€‚ä¸å°‘ä¼ä¸šåŒ…å«çº¢å¸½å…¬å¸ï¼Œéƒ½å°†å…¶ä½œä¸ºå…¶ç«™ç‚¹çš„å•ç‚¹ç™»å½•å·¥å…·ï¼Œé€šè¿‡ä½¿ç”¨ Keycloakï¼Œåªéœ€è¦**å°‘é‡ç¼–ç ç”šè‡³ä¸ç”¨ç¼–ç **ï¼Œå°±èƒ½å¾ˆå®¹æ˜“åœ°ä½¿åº”ç”¨ç¨‹åºå’ŒæœåŠ¡æ›´**å®‰å…¨**ã€‚

è€Œåœ¨ä¸­å›½ï¼Œä¼ä¸šå¾€å¾€é€šè¿‡**å¾®ä¿¡å…¬ä¼—å·**å’Œç²‰ä¸è¿›è¡Œäº’åŠ¨ï¼Œä»¥åŠé€šè¿‡å…¬ä¼—å·è¿›è¡Œå¾®ä¿¡è¥é”€ç­‰ç­‰ï¼Œå¾®ä¿¡å…¬ä¼—å·ç²‰ä¸å’Œä¼ä¸šç½‘ç«™çš„ç”¨æˆ·å…¶å®æœ‰å¤šç‚¹ç™»å½•çš„åœºæ™¯ï¼Œå› æ­¤å¦‚æœèƒ½å¤Ÿå°†**å¾®ä¿¡ç™»å½•æ¥å…¥åˆ°å•ç‚¹ç™»å½•**ç¯èŠ‚ï¼Œä¸ä»…ä¼šæ–¹ä¾¿ç”¨æˆ·ï¼Œä¹Ÿä¼šæ–¹ä¾¿ä¼ä¸šã€‚ä½†æ˜¯å¾®ä¿¡å®˜æ–¹çš„ **OAuth ç™»å½•**å´æ˜¯å’Œ**å…¬ä¼—å·ç‹¬ç«‹**çš„ï¼Œä¸€ä¸ªæ˜¯å¼€æ”¾å¹³å°ï¼Œä¸€ä¸ªæ˜¯å…¬ä¼—å¹³å°ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡ç›¸äº’ç»‘å®šä¹‹åä½¿ç”¨ unionid å…³è”ä¸¤ä¸ªå¹³å°é‡Œçš„åŒä¸€ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯åœ¨å¾®ä¿¡çš„ OAuth ç™»å½•ç¯èŠ‚ï¼Œä¸éœ€è¦å…¬ä¼—å·çš„å‚ä¸ï¼Œä¼ä¸šå¤±å»äº†ä¸€æ¬¡å’Œç”¨æˆ·äº’åŠ¨çš„æœºä¼šã€‚

æ›´å¥½çš„åšæ³•æ˜¯ï¼Œç”¨æˆ·é€‰æ‹©**å¾®ä¿¡ç™»å½•**ï¼Œæ‰«ç åæ‰‹æœºå·è¢«**å¯¼æµåˆ°ä¼ä¸šå…¬ä¼—å·**ï¼Œä¸€æ—¦**æ–°ç”¨æˆ·å…³æ³¨å…¬ä¼—å·æˆ–è€…è€ç”¨æˆ·è¿›å…¥åˆ°å…¬ä¼—å·**é¡µé¢ï¼Œä¾¿èƒ½å¤Ÿæ¥æ”¶åˆ°ä¸€æ¡**å®šåˆ¶åŒ–çš„æ¬¢è¿**ä¿¡æ¯ï¼ŒåŒæ—¶ç½‘é¡µç«™ç‚¹**è‡ªåŠ¨ç™»å½•**æˆåŠŸã€‚

## å¥½å¤„

1ã€ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼šå¯¹äºè€ç”¨æˆ·**æ‰«ç åå³ç™»å½•**ï¼Œä¸éœ€è¦**äºŒæ¬¡ç‚¹å‡»**ï¼›å¯¹äºæ–°ç”¨æˆ·ï¼Œåªéœ€è¦ç‚¹å‡»å…³æ³¨ã€‚æ— è®ºæ–°è€ç”¨æˆ·éƒ½èƒ½æ”¶åˆ°å¯çˆ±çš„æ¬¢è¿ä¿¡æ¯ï¼Œæ„Ÿè§‰**äº²åˆ‡**ã€‚

2ã€å¼€å‘æ›´ä¾¿æ·ï¼šä¸ç”¨**å¯¹æ¥å¼€æ”¾å¹³å°**ã€ä¸ç”¨è€ƒè™‘ **unionid**ã€‚

3ã€è¿è¥æ›´çœå¿ƒï¼šä¸ç”¨**é¢å¤–æ¯å¹´è®¤è¯ä¸€æ¬¡**å¼€æ”¾å¹³å°ï¼Œ**å¾®ä¿¡ç²‰ä¸å’Œç½‘ç«™ç”¨æˆ·**ä¸€ä¸€å¯¹åº”ã€‚

## å®ç°æ•ˆæœé¢„è§ˆ

æ³¨æ„ï¼Œç”±äºæµ‹è¯•å…¬ä¼—å·çš„é™åˆ¶ï¼Œåªèƒ½æ”¯æŒ 100 åç”¨æˆ·ã€‚å¦‚æœç”±äºç”¨æˆ·è¶…é™å¯¼è‡´é¢„è§ˆä¸æˆåŠŸï¼Œå¯ä»¥æ”¾å¿ƒè·³è¿‡é¢„è§ˆå¾€ä¸‹çœ‹å®ç°ç»†èŠ‚ã€‚

ç‚¹å‡»è¿™ä¸ªé“¾æ¥ï¼ˆæ‰‹æœºç«¯å¾®ä¿¡å†…ç½‘é¡µæ‰“å¼€æˆ–è€…ä»æ¡Œé¢ç½‘é¡µæ‰“å¼€éƒ½å¯ä»¥å·¥ä½œï¼‰ï¼š

[https://keycloak.jiwai.win/auth/realms/UniHeart/login-actions/authenticate?execution=2668dd1a-735d-4fd4-b4ea-400309a4289c&client_id=account&tab_id=oXaMd2IidLE](https://link.zhihu.com/?target=https%3A//keycloak.jiwai.win/auth/realms/UniHeart/login-actions/authenticate%3Fexecution%3D2668dd1a-735d-4fd4-b4ea-400309a4289c%26client_id%3Daccount%26tab_id%3DoXaMd2IidLE)

æ‰“å¼€ç™»å½•ç•Œé¢å¦‚ä¸‹ï¼š

![img](https://pic4.zhimg.com/80/v2-b03170db47e3bda035a549274cde411f_1440w.jpg)

å¯ä»¥çœ‹åˆ°åœ¨é»˜è®¤çš„ Keycloak ç™»å½•æ¡†å³è¾¹æœ‰ä¸€ä¸ªâ€œå¾®ä¿¡â€é€‰é¡¹ï¼Œç‚¹å‡»å®ƒå¯ä»¥æ‰“å¼€ä¸€ä¸ªäºŒç»´ç ï¼Œæ‰«ç åï¼Œä¼šè¿›å…¥åˆ°æˆ‘çš„æµ‹è¯•å…¬ä¼—å·ç•Œé¢ï¼Œå¦‚æœä½ å·²ç»å…³æ³¨ï¼Œé‚£ä¹ˆä¼šæ”¶åˆ°ä¸€æ¡æ¬¢è¿ä¿¡æ¯å¹¶æˆåŠŸç™»å½•ç³»ç»Ÿï¼›å¦‚æœä½ æ²¡æœ‰å…³æ³¨è¿‡ï¼Œåˆ™éœ€è¦ç‚¹å‡»å…³æ³¨ï¼Œç„¶ååœ¨æ”¶åˆ°æ¬¢è¿ä¿¡æ¯çš„åŒæ—¶ï¼ŒæˆåŠŸç™»å½•ç³»ç»Ÿã€‚

![img](https://pic4.zhimg.com/80/v2-c72225a6cd9f1060dc6d56bbbb04a123_1440w.jpg)

![img](https://pic3.zhimg.com/80/v2-a2aa3dc6a1b606be1fcd615ec541dcca_1440w.jpg)

ä»¥ä¸Šæ˜¯æˆåŠŸç™»å½•ç³»ç»Ÿåè¿›å…¥åˆ°ä¸ªäººè´¦å·é¡µé¢çš„æˆªå›¾ï¼Œæ³¨æ„ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç™»å½•ï¼Œé‚£ä¹ˆéœ€è¦éªŒè¯ç”µå­é‚®ä»¶åæ‰èƒ½è¿›å…¥è¿™ä¸ªé¡µé¢ï¼ˆæ˜¯å¦éªŒè¯ç”µå­é‚®ä»¶å¯ä»¥åœ¨ Keycloak ä¸­é…ç½®ï¼‰ã€‚

# æ¦‚å¿µç®€ä»‹

[keycloak](https://www.keycloak.org/) æ˜¯ä¸€ä¸ªé’ˆå¯¹Webåº”ç”¨å’ŒRESTfull Web API æä¾›SSOï¼ˆSingle Sign Onï¼šå•ç‚¹ç™»é™†ï¼‰ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼€æºè½¯ä»¶ï¼Œæºç åœ°å€æ˜¯ï¼šhttps://github.com/keycloak/keycloak/

æ ¸å¿ƒæ¦‚å¿µï¼š

usersï¼šç”¨æˆ·æ˜¯ä¸€ä¸ªå¯ä»¥ç™»é™†ç³»ç»Ÿçš„å®ä½“ï¼Œå®ƒå¯ä»¥æ‹¥æœ‰è”ç³»å®ƒä»¬è‡ªèº«çš„å±æ€§ï¼Œä¾‹å¦‚é‚®ç®±ã€ç”¨æˆ·åã€åœ°å€ã€ç”µè¯å·ç æˆ–ç”Ÿæ—¥ç­‰ï¼Œå¯ä»¥ä¸ºuseråˆ†é…ç»„åˆ«æˆ–è€…è§’è‰²ã€‚

authenticationï¼šç›¸å½“äºå¯†ç ï¼Œå¯ä»¥éªŒè¯å’Œè¯†åˆ«ä¸€ä¸ªuserã€‚

authorizationï¼šç»™äºˆç”¨æˆ·è®¿é—®çš„è¿‡ç¨‹ã€‚

credentialsï¼šè¯ä¹¦ï¼Œå¯ä»¥ä¾›keycloakéªŒè¯ç”¨æˆ·çš„ä¸œè¥¿ï¼Œä¾‹å¦‚å¯†ç ã€ä¸€æ¬¡æ€§å¯†ç ã€è¯ä¹¦ã€æŒ‡çº¹ç­‰ã€‚

rolesï¼šç›¸å½“äºç”¨æˆ·çš„ä¸€ä¸ªåˆ†ç±» ï¼Œä¸€ä¸ªç»„ç»‡å¯èƒ½æœ‰Admin\user\manager\employeeç­‰è§’è‰²ï¼Œåº”ç”¨ç¨‹åºç»å¸¸ä¼šåˆ†é…æƒé™ç»™è§’è‰²ï¼Œè€Œä¸æ˜¯ç”¨æˆ·ï¼Œå› ä¸ºç”¨æˆ·å¤ªéš¾ç®¡ç†ã€‚

user role mappingï¼šå®šä¹‰äº†ä¸€ä¸ªç”¨æˆ·åŠè§’è‰²çš„å…³ç³»ï¼Œä¸€ä¸ªç”¨æˆ·å¯ä»¥å±äºé›¶ä¸ªæˆ–å¤šä¸ªè§’è‰²ï¼Œç”¨æˆ·ä¸è§’è‰²çš„æ˜ å°„å…³ç³»ï¼Œè¿™æ ·å°±å¯ä»¥å†³å®šç”¨åœ¨å„ç§èµ„æºè®¿é—®çš„æƒé™ç®¡ç†ã€‚

composite rolesï¼šå¤åˆè§’è‰²å¯ä»¥åŒ…å«å…¶ä»–çš„è§’è‰²ï¼Œç”¨æˆ·æ‹¥æœ‰äº†å¤åˆè§’è‰²å°±ç›¸å½“äºæ‹¥æœ‰äº†å®ƒä¸‹é¢çš„æ‰€æœ‰å­è§’è‰²ã€‚

groupsï¼šç»„å¯ä»¥ä¸€ç»„çš„ç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥å°†è§’è‰²æ˜ å°„åˆ°è§’è‰²ä¸­ï¼Œç”¨æˆ·å¯ä»¥æˆä¸ºç»„å‘˜åç»§æ‰¿ç”¨ç»„çš„è§’è‰²

realmsï¼šé¢†åŸŸï¼Œé¢†åŸŸç®¡ç†ç€ä¸€æ‰¹ï¼Œç”¨æˆ·ã€è¯ä¹¦ã€è§’è‰²ã€ç»„ç­‰ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½å±äºä¸”èƒ½ç™»é™†åˆ°ä¸€ä¸ªåŸŸï¼ŒåŸŸä¹‹é—´æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼ŒåŸŸåªèƒ½ç®¡ç†åœ¨å®ƒä¸‹é¢çš„ç”¨æˆ·ã€‚

clientsï¼šå®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªå®ä½“ï¼Œå¯ä»¥è¯·æ±‚keycloakå¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æ˜¯åº”ç”¨æˆ–æœåŠ¡å¸Œæœ›ä½¿ç”¨keycloakæ¥ä¿æŠ¤è‡ªå·±å’Œæä¾›ä¸€ä¸ªå•ç‚¹ç™»å½•çš„è§£å†³æ–¹æ¡ˆã€‚å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå®ä½“ï¼Œè¯·æ±‚èº«ä»½ä¿¡æ¯æˆ–ä¸€ä¸ªè®¿é—®ä¿¡æ¯ï¼Œè¿™æ ·å°±å¯ä»¥è°ƒç”¨å…¶ä»–keycloakä¿æŠ¤çš„åº”ç”¨æˆ–æœåŠ¡äº†ã€‚

client adaptersï¼š

```
é…ç½®ä¼šæœ‰ä»¥ä¸‹æ¨¡å—ï¼š
Realm è®¾ç½®: åŸºæœ¬è®¾ç½®ï¼ŒåŒ…æ‹¬æ˜¯å¦å…è®¸æ³¨å†Œï¼Œç™»é™†ç•Œé¢ï¼Œtokenæœ‰æ•ˆæœŸç­‰
Clients: è¢«è®¤å¯ç­‰å®¢æˆ·ç«¯æˆ–æœåŠ¡ï¼Œæ”¯æŒ openid-connectï¼Œsaml åè®®Clients 
ScopesRoles: è§’è‰²å®šä¹‰ï¼Œåˆ† realm è§’è‰²å’Œ client è§’è‰²ï¼Œï¼ˆè¿˜æœ‰æ··åˆä¸¤ç§çš„è§’è‰²ï¼‰ï¼Œç„¶åå¯ä»¥ç»‘å®šç»™ç”¨æˆ·ï¼Œå¦ï¼šä½ å¯ä»¥ä¸ºæ¯ä¸ªclientæŒ‡å®šæ˜¯role scopeï¼ˆæ˜¯å¦ä»…è¿”å›client roleï¼‰
Identity Providers: ç¬¬ä¸‰æ–¹ç™»é™†é…ç½®ï¼Œä¾‹å¦‚é…ç½®é€šè¿‡ github ç™»é™†ç­‰User 
Federation: ç”¨æˆ·è”é‚¦ï¼Œç”¨æˆ·å¯ä»¥ä» LDAP/ADï¼ŒKerberos ç­‰åŒæ­¥
authentication: å®šä¹‰æ”¯æŒçš„ç™»é™†æ–¹å¼ï¼ŒåŒ…æ‹¬ç™»å½•çš„å¯†ç è§„åˆ™å®šä¹‰ç­‰
ç®¡ç†æœ‰ä»¥ä¸‹æ¨¡å—ï¼š
groups: ç»„ç®¡ç†
users: ç”¨æˆ·ç®¡ç†
Sesssions: session ç®¡ç†
events: äº‹ä»¶ç®¡ç†
Import: é€šè¿‡xmlå¯¼å…¥æ•°æ®
Export: å¯¼å‡ºæ•°æ®
```

## å•ç‚¹ç™»å½•

Keycloak æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å¼€æºçš„å•ç‚¹ç™»å½•å·¥å…·ã€‚æƒ³ä½¿ç”¨ç³»ç»Ÿ Bçš„ç”¨æˆ·ç›´æ¥ç™»å½•ç³»ç»Ÿ Aï¼Œè€Œä¸ç”¨å†æ¬¡å»ç³»ç»Ÿ A é‡Œæ³¨å†Œï¼Œè¿™ä¹Ÿæ˜¯å…¸å‹çš„å•ç‚¹ç™»å½•åœºæ™¯ã€‚å•ç‚¹ç™»å½•æœ‰å¤šç§åè®®ï¼š

### å•ç‚¹ç™»å½•è®¤è¯åè®®

æœ€çŸ¥åçš„å•ç‚¹ç™»å½•è®¤è¯åè®®ä¸»è¦æ˜¯ OpenId Connect å’Œ SAMLã€‚ä¸‹é¢å°±æ¥çœ‹çœ‹è®¤è¯æœåŠ¡å™¨å’Œè¢«ä¿æŠ¤çš„åº”ç”¨æ˜¯æ€ä¹ˆå’Œè¿™äº›åè®®æ‰“äº¤é“çš„ã€‚

### OpenId Connect

OpenId Connect é€šå¸¸ç®€ç§°ä¸º OIDCï¼Œå®ƒæ˜¯åœ¨ OAuth 2.0 çš„åŸºç¡€ä¸Šæ‰©å±•è€Œæˆçš„è®¤è¯åè®®ã€‚OAuth 2.0 åªæ˜¯ä¸€ä¸ªæ„å»ºè®¤è¯åè®®çš„æ¡†æ¶ï¼Œå¹¶ä¸”å¾ˆä¸å®Œæ•´ï¼Œä½†æ˜¯ OIDC ç¡®å®ä¸€ä¸ªç¾½ç¿¼ä¸°æ»¡çš„è®¤è¯ä¸æˆæƒåè®®ã€‚OIDC ä¸¥é‡ä½¿ç”¨ Json Web Tokenï¼ˆJWTï¼‰æ ‡å‡†ã€‚è¿™äº›æ ‡å‡†ç”¨ç´§å‡‘å’Œå¯¹ç½‘ç»œå‹å¥½çš„æ–¹å¼å®šä¹‰äº† JSON æ ¼å¼çš„å”¯ä¸€æ ‡è®°ä»¥åŠå¯¹æ•°æ®è¿›è¡Œæ•°å­—åŒ–ç­¾åå’ŒåŠ å¯†çš„æ–¹æ³•ã€‚

OIDC åœ¨ Keycloak ä¸­çš„ä½¿ç”¨åœºæ™¯åˆ†ä¸ºä¸¤ç§ç±»å‹ã€‚ç¬¬ä¸€ç§æ˜¯åº”ç”¨è¯·æ±‚ Keycloak æœåŠ¡å™¨æ¥è®¤è¯ç”¨æˆ·ã€‚å½“æˆåŠŸç™»å½•åï¼Œåº”ç”¨ä¼šæ”¶åˆ°ä¸€ä¸ªåç§°ä¸º `access_token` çš„å”¯ä¸€èº«ä»½æ ‡å¿—ç¬¦ã€‚è¿™ä¸ªå”¯ä¸€èº«ä»½æ ‡å¿—ç¬¦åŒ…å«äº†è¯¸å¦‚ç”¨æˆ·åã€ç”µå­é‚®ç®±ã€ä»¥åŠå…¶ä»–ä¸ªäººèµ„æ–™ç­‰ç­‰ä¿¡æ¯ã€‚ `access_token` ä¼šè¢« realm è¿›è¡Œæ•°å­—ç­¾åï¼Œå¹¶ä¸”åŒ…å«ç”¨æˆ·çš„å¯è®¿é—®ä¿¡æ¯ï¼ˆæ¯”å¦‚ç”¨æˆ·-è§’è‰²æ˜ å°„ï¼‰ï¼Œä»è€Œåº”ç”¨å¯ä»¥ä½¿ç”¨å®ƒæ¥å†³å®šè¯¥ç”¨æˆ·è¢«å…è®¸è®¿é—®åº”ç”¨ä¸­çš„å“ªäº›èµ„æºï¼ˆä¸Šé¢çš„åœ¨çº¿æ¼”ç¤ºä¸­æ˜¾ç¤ºçš„å·²ç™»å½•ç”¨æˆ·æ²¡æœ‰æƒé™é¡µé¢ï¼Œå°±æ˜¯å› ä¸ºæ‹¿åˆ°çš„ `access_token` ä¸­æ²¡æœ‰ç›¸å…³çš„å¯è®¿é—®ä¿¡æ¯ï¼‰ã€‚

ç¬¬äºŒç§ä½¿ç”¨åœºæ™¯ç±»å‹æ˜¯å®¢æˆ·ç«¯æƒ³è·å–è¿œç«¯æœåŠ¡çš„è®¿é—®æƒé™ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œå®¢æˆ·ç«¯è¯·æ±‚ Keycloak æ¥è·å–ä¸€ä¸ªè®¿é—®ä»¤ç‰Œæ¥ä»£è¡¨ç”¨æˆ·è°ƒç”¨è¿œç«¯æœåŠ¡ã€‚Keycloak è®¤è¯è¯¥ç”¨æˆ·åè¯¢é—®ç”¨æˆ·æ˜¯å¦åŒæ„ä¸ºè¯¥å®¢æˆ·ç«¯æˆäºˆè®¿é—®æƒé™ã€‚ä¸€æ—¦ç”¨æˆ·åŒæ„æˆæƒï¼Œå®¢æˆ·ç«¯å°±ä¼šæ”¶åˆ°è®¿é—®ä»¤ç‰Œã€‚è¿™ä¸ªè®¿é—®ä»¤ç‰Œæ˜¯ç”± realm æ•°å­—åŒ–ç­¾åè¿‡çš„ã€‚è¯¥å®¢æˆ·ç«¯éšåå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªè®¿é—®ä»¤ç‰Œå‘è¿œç«¯æœåŠ¡å‘èµ· REST è°ƒç”¨äº†ã€‚è¿™ä¸ª REST æœåŠ¡æŠ½å–å‡ºè®¿é—®ä»¤ç‰Œï¼ŒéªŒè¯ä»¤ç‰Œçš„ç­¾åï¼Œç„¶ååŸºäºä»¤ç‰Œä¸­çš„å¯è®¿é—®ä¿¡æ¯å†³å®šæ˜¯å¦ä¿æŠ¤è¿™ä¸ªè°ƒç”¨è¯·æ±‚ã€‚

### OIDC è®¤è¯æµç¨‹

OIDC æœ‰å¤šç§ä¸åŒçš„æ–¹å¼ä¸ºå®¢æˆ·ç«¯æˆ–è€…åº”ç”¨æä¾›ç”¨æˆ·è®¤è¯å¹¶æ¥æ”¶èº«ä»½æ ‡è®°å’Œè®¿é—®ä»¤ç‰Œã€‚ä½ è¦ä½¿ç”¨é‚£ç§æ–¹å¼å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºåº”ç”¨æˆ–è€…å®¢æˆ·ç«¯è¯·æ±‚è®¿é—®æƒé™çš„ç±»å‹ã€‚æ‰€ä»¥ OIDC çš„è®¤è¯æµç¨‹æ—¢å’Œ Oauth2 ç±»ä¼¼åˆæœ‰åŒºåˆ«ï¼ŒåŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. å®¢æˆ·ç«¯å‡†å¤‡åŒ…å«æ‰€éœ€è¯·æ±‚å‚æ•°çš„èº«ä»½éªŒè¯è¯·æ±‚ã€‚
2. å®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€åˆ°æˆæƒæœåŠ¡å™¨ã€‚
3. æˆæƒæœåŠ¡å™¨å¯¹ç»ˆç«¯ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ã€‚
4. æˆæƒæœåŠ¡å™¨è·å¾—ç»ˆç«¯ç”¨æˆ·åŒæ„/æˆæƒã€‚
5. æˆæƒæœåŠ¡å™¨å°† code å‘é€å›å®¢æˆ·ç«¯ ã€‚
6. å®¢æˆ·ç«¯å°† code å‘é€åˆ°ä»¤ç‰Œç«¯ç‚¹è·å– access_token å’Œ idTokenã€‚
7. å®¢æˆ·ç«¯ä½¿ç”¨ç§é’¥éªŒè¯ idToken æ‹¿åˆ°ç”¨æˆ·æ ‡è¯† or å°† access_token å‘é€åˆ°æˆæƒæœåŠ¡å™¨è·å–ç”¨æˆ·æ ‡è¯†ã€‚

è¿™é‡Œæ³¨æ„æœ€åç¬¬ 6ã€7 ç‚¹æ“ä½œï¼Œè¿™é‡Œå¼€å§‹ OIDC å’Œ Oauth2 ä¸ä¸€æ ·äº†

### æˆæƒç æµç¨‹

è¿™æ˜¯ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„åè®®ï¼Œä¹Ÿæ˜¯åœ¨éªŒè¯å’ŒæˆæƒåŸºäºæµè§ˆå™¨çš„åº”ç”¨æ—¶æ‰€æ¨èä½¿ç”¨çš„ã€‚å®ƒä¸¥é‡ä¾èµ–æµè§ˆå™¨é‡å®šå‘æ¥è·å–èº«ä»½æ ‡è®°ä¸è®¿é—®ä»¤ç‰Œã€‚æ€»ç»“å¦‚ä¸‹ï¼š

1. ä½¿ç”¨æµè§ˆå™¨è®¿é—®åº”ç”¨ã€‚è¿™ä¸ªåº”ç”¨ä¼šæé†’ç”¨æˆ·å½“å‰è¿˜æœªç™»å½•ï¼Œæ‰€ä»¥å®ƒæŒ‡ç¤ºæµè§ˆå™¨é‡å®šå‘åˆ° Keycloak æ¥è®¤è¯ã€‚è¯¥åº”ç”¨ä¼šä»¥æŸ¥è¯¢å‚æ•°çš„å½¢å¼åœ¨æµè§ˆå™¨é‡å®šå‘æ—¶å‘ Keycloak ä¼ é€’ä¸€ä¸ªå›è°ƒ URLï¼ˆå³æ¼”ç¤ºæˆªå›¾ä¸­çš„ redirect_uriï¼‰ï¼ŒKeycloak åœ¨å®Œæˆè®¤è¯åä¼šä½¿ç”¨åˆ°å®ƒã€‚
2. Keycloak è®¤è¯ç”¨æˆ·ï¼Œå¹¶åˆ›å»ºä¸€æ¬¡æ€§ã€éå¸¸çŸ­æ—¶é—´æœ‰æ•ˆçš„ä¸´æ—¶ç ã€‚Keycloak é€šè¿‡å‰é¢æä¾›çš„å›è°ƒ URL é‡å®šå‘å›åˆ°åº”ç”¨ï¼ŒåŒæ—¶å°†ä¸´æ—¶ç ä½œä¸ºæŸ¥è¯¢å‚æ•°é™„åŠ åˆ°å›è°ƒ URL ä¸Šã€‚
3. åº”ç”¨æŠ½å–ä¸´æ—¶ç ï¼Œå¹¶ä¸”åœ¨åç«¯é€šè¿‡ä¸åŒäºå‰ç«¯çš„ç½‘ç»œæ¸ é“å‘ Keycloak å‘èµ· REST è°ƒç”¨ï¼Œä½¿ç”¨ä¸´æ—¶ç äº¤æ¢èº«ä»½æ ‡è®°ã€è®¿é—®ä»¤ç‰Œä»¥åŠåˆ·æ–°ä»¤ç‰Œã€‚ä¸€æ—¦è¿™ä¸ªä¸´æ—¶ç åœ¨è·å–ä»¤ç‰Œä¸­è¢«ä½¿ç”¨è¿‡äº†ï¼Œå®ƒå°±ä¸èƒ½å†æ¬¡è¢«ä½¿ç”¨äº†ã€‚è¿™é˜²æ­¢äº†æ½œåœ¨çš„é‡æ”¾æ”»å‡»ã€‚

éå¸¸é‡è¦çš„ä¸€ç‚¹æ˜¯è®¿é—®ä»¤ç‰Œé€šå¸¸æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼Œä¸€èˆ¬åœ¨åˆ†é’Ÿçº§åˆ«è¿‡æœŸã€‚è€Œåˆ·æ–°ä»¤ç‰Œç”±ç™»å½•åè®®ä¼ é€ï¼Œå…è®¸åº”ç”¨åœ¨è®¿é—®ä»¤ç‰Œè¿‡æœŸåå»è·å–ä¸€ä¸ªæ–°çš„è®¿é—®ä»¤ç‰Œã€‚è¿™æ ·ä¸€ä¸ªåˆ·æ–°åè®®åœ¨å—æŸç³»ç»Ÿä¸­éå¸¸é‡è¦ã€‚å¦‚æœè®¿é—®ä»¤ç‰Œæœ‰æ•ˆæœŸå¾ˆçŸ­ï¼Œé‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿä»…ä»…åœ¨è¢«ç›—ç”¨çš„ä»¤ç‰Œå‰©ä½™çš„æœ‰æ•ˆæœŸå†…æ˜¯å¤„äºè¢«æ”»å‡»çŠ¶æ€çš„ã€‚å¦‚æœç®¡ç†å‘˜åŠé”€äº†è®¿é—®æƒé™ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çš„ä»¤ç‰Œåˆ·æ–°è¯·æ±‚ä¼šå¤±è´¥ã€‚è¿™æ ·æ›´åŠ å®‰å…¨å¹¶ä¸”å¯ä¼¸ç¼©æ€§æ›´å¥½ã€‚

è¯¥æµç¨‹å¦ä¸€ä¸ªé‡è¦çš„æ–¹é¢æ˜¯æ‰€è°“çš„å¼€æ”¾å®¢æˆ·ç«¯è¿˜æ˜¯ä¿å¯†å®¢æˆ·ç«¯çš„æ¦‚å¿µã€‚ä¿å¯†çš„å®¢æˆ·ç«¯åœ¨ä½¿ç”¨ä¸´æ—¶ç äº¤æ¢ä»¤ç‰Œæ—¶éœ€è¦æä¾›å®¢æˆ·ç«¯å¯†é’¥ã€‚å¼€æ”¾å®¢æˆ·ç«¯åˆ™ä¸éœ€è¦ã€‚åªè¦ä¸¥æ ¼ä½¿ç”¨ HTTPS å¹¶ä¸”å®¢æˆ·ç«¯çš„é‡å®šå‘ URI è¢«ä¸¥æ ¼æ³¨å†Œï¼Œé‚£ä¹ˆé‡‡ç”¨å¼€æ”¾å®¢æˆ·ç«¯å®Œå…¨æ²¡æœ‰é—®é¢˜ã€‚ç”±äºæ— æ³•ä½¿ç”¨å®‰å…¨çš„æ–¹å¼ä¼ è¾“å®¢æˆ·ç«¯å¯†é’¥ï¼Œæ‰€ä»¥ HTML5/JavaScript å®¢æˆ·ç«¯ä¸å¾—ä¸å¤©ç„¶å°±å±äºå¼€æ”¾å®¢æˆ·ç«¯ã€‚å†æ¬¡å¼ºè°ƒï¼Œè¿™ä»…ä»…åœ¨ä¸¥æ ¼ä½¿ç”¨ HTTPS å¹¶ä¸¥æ ¼æ³¨å†Œé‡å®šå‘ URI æ—¶æ˜¯å¯ä»¥çš„ã€‚

### éšå¼æµç¨‹

è¿™ä¹Ÿæ˜¯ä¸€ä¸ªåŸºäºæµè§ˆå™¨çš„åè®®ï¼Œå¾ˆç±»ä¼¼æˆæƒç æµç¨‹ï¼Œåªæ˜¯è¯·æ±‚é‡æ›´å°‘ï¼Œä¹Ÿä¸éœ€è¦åˆ·æ–°ä»¤ç‰Œã€‚è¯¥æµç¨‹ä¸è¢«æ¨èï¼Œå› ä¸ºå­˜åœ¨è®¿é—®ä»¤ç‰Œæ³„æ¼çš„å¯èƒ½æ€§ã€‚æ¯”å¦‚ç”±äºä»¤ç‰Œé€šè¿‡é‡å®šå‘ URI ï¼ˆè¯¦è§ä¸‹ï¼‰ä¼ è¾“ï¼Œæ‰€ä»¥å¯èƒ½é€šè¿‡æµè§ˆå™¨å†å²è®°å½•æ³„æ¼ã€‚å¹¶ä¸”ï¼Œç”±äºè¯¥æµç¨‹æ²¡æœ‰ä¸ºå®¢æˆ·ç«¯æä¾›åˆ·æ–°ä»¤ç‰Œçš„æœåŠ¡ï¼Œæ‰€ä»¥è®¿é—®ä»¤ç‰Œä¸å¾—ä¸è®¾ç½®ä¸€ä¸ªæ›´é•¿çš„æ—¶é—´ï¼Œä¸ç„¶å½“ä»¤ç‰Œå¤±æ•ˆåç”¨æˆ·éœ€è¦å†æ¬¡è®¤è¯ã€‚Keycloak ä¸æ¨èè¿™ç§æµç¨‹ä½†æ˜¯ä»ç„¶æ”¯æŒè¿™ç§æµç¨‹ï¼Œå› ä¸ºå®ƒå­˜åœ¨äº OIDC å’Œ OAuth 2.0 çš„è§„æ ¼æ–‡æ¡£ä¸­ã€‚æ€»ç»“å¦‚ä¸‹ï¼š

1. ä½¿ç”¨æµè§ˆå™¨è®¿é—®åº”ç”¨ã€‚åº”ç”¨æç¤ºç”¨æˆ·å½“å‰è¿˜æœªç™»å½•ï¼Œæ‰€ä»¥å®ƒæŒ‡ç¤ºæµè§ˆå™¨é‡å®šå‘åˆ° Keycloak å»è®¤è¯ã€‚åº”ç”¨å°†å›è°ƒ URL ï¼ˆä¸€ä¸ªé‡å®šå‘ URIï¼‰ä½œä¸ºæŸ¥è¯¢å‚æ•°ä¼ é€’ç»™ Keycloakï¼Œåœ¨è®¤è¯å®Œæˆåä¼šè¢«å…¶ä½¿ç”¨ã€‚
2. Keycloak è®¤è¯ç”¨æˆ·å¹¶ä¸”åˆ›å»ºèº«ä»½æ ‡è®°å’Œè®¿é—®ä»¤ç‰Œã€‚Keycloak ä½¿ç”¨ä¹‹å‰æä¾›çš„å›è°ƒ URL é‡å®šå‘å›åˆ°åº”ç”¨å¹¶ä½¿ç”¨æŸ¥è¯¢å‚æ•°çš„æ–¹å¼é¢å¤–æ·»åŠ èº«ä»½æ ‡è®°å’Œè®¿é—®ä»¤ç‰Œåœ¨å›è°ƒ URL zhongã€‚
3. åº”ç”¨ä»å›è°ƒ URL ä¸­æŠ½å–èº«ä»½æ ‡è®°å’Œè®¿é—®ä»¤ç‰Œã€‚

### èµ„æºæ‹¥æœ‰è€…å¯†ç å‡­æ®æˆæƒï¼ˆç›´æ¥è®¿é—®æˆæƒï¼‰

è¿™åœ¨ Keycloak ç®¡ç†å‘˜æ§åˆ¶å°ä¸­æŒ‡ç›´æ¥è®¿é—®æˆæƒã€‚å½“ REST å®¢æˆ·ç«¯å¸Œæœ›ä»£è¡¨ç”¨æˆ·è·å–ä»¤ç‰Œæ—¶ä½¿ç”¨è¯¥æµç¨‹ã€‚è¿™æ˜¯ä¸€ä¸ª HTTP POST è¯·æ±‚ï¼Œè¯¥è¯·æ±‚ä¸­åŒ…å«äº†ç”¨æˆ·çš„å®‰å…¨å‡­æ®å’Œå®¢æˆ·ç«¯ idï¼Œä»¥åŠå®¢æˆ·ç«¯çš„å¯†é’¥ï¼ˆå¦‚æœæ˜¯ä¿å¯†å®¢æˆ·ç«¯çš„è¯ï¼‰ã€‚è¯¥ç”¨æˆ·çš„å®‰å…¨å‡­æ®éšè¯·æ±‚ä¸­çš„è¡¨å•å‚æ•°å‘é€ã€‚è¿™ä¸ª HTTP å“åº”ä¸­åŒ…å«çš„èº«ä»½æ ‡è®°ã€è®¿é—®æƒé™ï¼Œä»¥åŠåˆ·æ–°ä»¤ç‰Œã€‚

### å®¢æˆ·ç«¯å‡­æ®æˆæƒ

è¿™ä¹Ÿæ˜¯ç”± REST å®¢æˆ·ç«¯ä½¿ç”¨çš„ï¼Œä½†ä¸æ˜¯ä»£è¡¨ä¸€ä¸ªå¤–éƒ¨ç”¨æˆ·å»è·å–ä»¤ç‰Œï¼Œè€Œæ˜¯åŸºäºå’Œå®¢æˆ·ç«¯ç›¸å…³çš„å…ƒæ•°æ®ä¸æœåŠ¡è´¦å·çš„æƒé™æ¥åˆ›å»ºä¸€ä¸ªä»¤ç‰Œã€‚

# æ“ä½œ

## åˆ›å»ºæ–°çš„é¢†åŸŸ(realm)

Realmæ˜¯ä¸€ä¸ªéš”ç¦»çš„æ¦‚å¿µï¼ŒRealm Aä¸­çš„ç”¨æˆ·ä¸Realm Bä¸­çš„ç”¨æˆ·å®Œå…¨éš”ç¦»ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸åˆ›å»ºRealmï¼Œç›´æ¥ç”¨ Master è¿™ä¸ªRealmï¼Œä¸è¿‡ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†èµ„æºçš„éš”ç¦»ï¼Œä»¥åŠæ›´å¥½çš„å®‰å…¨æ€§ä¸å¤ªå»ºè®®ä¸ç®¡ç†å‘˜å…±ç”¨Realmã€‚ä»Masterçš„ä¸‹æ‹‰èœå•ä¸­ç‚¹å‡»"Add Realm"ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://upload-images.jianshu.io/upload_images/23610677-6dc21454cd9201df)

## åˆ›å»ºæ–°çš„ç”¨æˆ·

ç‚¹å‡»å·¦è¾¹å¯¼èˆªæ çš„Usersï¼Œç‚¹å‡»å³è¾¹çš„"Add user"æ¥åˆ›å»ºæ–°çš„ç”¨æˆ·ã€‚è¾“å…¥ç”¨æˆ·åï¼Œæ­¤å‚æ•°æ˜¯å¿…é¡»è¾“å…¥ï¼Œå…¶ä»–å­—æ®µå¯é€‰ã€‚ç‚¹å‡»ä¿å­˜ï¼Œä¼šå‡ºç°"Credentials"æ ‡ç­¾ï¼Œè¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åâ€reset passwordâ€,å¯ä»¥å…³é—­ä¸´æ—¶å¯†ç åŠŸèƒ½ã€‚å¦‚ä¸‹å›¾ï¼Œ

![img](https://upload-images.jianshu.io/upload_images/23610677-d1e1ae9bdd3845cf)

æ¥ç€ç™»å‡ºKeycloakï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„ç”¨æˆ·åå’Œå¯†ç ç™»é™†åˆ›å»ºçš„demo realmï¼Œhttp://localhost:8080/auth/realms/demo/accountã€‚

# dockerå®‰è£…gitlab-ce

```
docker run --name gitlab --hostname 192.168.2.45 -d -p 24:22 -p 80:80 -p 433:433 gitlab/gitlab-ce
```

åˆå§‹çš„å¯†ç åœ¨ä»¥ä¸‹æ–‡ä»¶ä¸­ï¼Œç™»å½•å**å°½å¿«ä¿®æ”¹å¯†ç **ï¼Œè¯¥æ–‡ä»¶ä¼šåœ¨24å°æ—¶å†…åˆ é™¤

```
/etc/gitlab/initial_root_password
```

![image-20220524174938305](http://myimg.go2flare.xyz/img/image-20220524174938305.png)

![gitlabè—æ–‡ä»¶](https://img-blog.csdnimg.cn/971a679ce8854faeaff393173898694a.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RpbW9uaXVt,size_16,color_FFFFFF,t_70)

## dockerå®‰è£…keycloak

```
docker run -dp 8080:8080 -e KEYCLOAK_ADMIN=admin -e KEYCLOAK_ADMIN_PASSWORD=changeme quay.io/keycloak/keycloak:18.0.0 start-dev
```

# å®ä¾‹

## å¾®ä¿¡ç™»é™†

### REF

> [ä½¿ç”¨ OIDC åœ¨ä¸€ä¸ª Keycloak ä¸­é›†æˆå¦ä¸€ä¸ª Keycloak ç”¨æˆ·è®¤è¯ - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/360846976)

### é—®é¢˜é‡è¿°

æˆ‘ç°åœ¨æœ‰2ä¸ªç³»ç»Ÿaå’Œbã€‚ä»–ä»¬éƒ½æ¥å…¥äº†keycloakï¼Œæ˜¯2ä¸ªrealmã€‚æ•°æ®åº“ä¹Ÿæ˜¯éš”ç¦»çš„ã€‚ç°åœ¨æƒ³è¦å®ç°aç³»ç»Ÿé€šè¿‡bç³»ç»Ÿçš„è´¦å·ç™»å½•ã€‚æˆ‘æƒ³ç”¨ç±»ä¼¼å¾®ä¿¡ç™»å½•çš„æ–¹å¼ï¼ŒæŠŠbç³»ç»Ÿå½“æˆå¾®ä¿¡ã€‚ä¸çŸ¥é“è¿™æ ·æ˜¯å¦åˆé€‚ï¼Œä»¥åŠå…·ä½“çš„å®ç°æ„Ÿè§‰æœ‰ç‚¹å›°éš¾ã€‚

è§£ç­”ï¼š

æŠŠbç³»ç»Ÿå½“æˆå¾®ä¿¡ï¼Œå®é™…ä¸Šå°±æ˜¯æŠŠbç³»ç»Ÿå½“æˆaç³»ç»Ÿçš„ä¸€ä¸ªidpï¼Œå³bç³»ç»Ÿæ˜¯aç³»ç»Ÿçš„èº«ä»½è®¤è¯æä¾›å•†ã€‚å¯ä»¥åœ¨aç³»ç»Ÿæ·»åŠ ä¸€ä¸ªidpï¼Œåœ¨é…ç½®æ—¶æŠŠbç³»ç»Ÿé…ç½®è¿›å»å°±è¡Œäº†

### å®ç°

## gitlabä½¿ç”¨SAMlåè®®

### REF

> [åœ¨è‡ªæ‰˜ç®¡ GitLab å®ä¾‹ä¸­é›†æˆ Keycloak ç™»å½• - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/405425214)

### é…ç½® KeyCloak

æ¥ä¸‹æ¥ï¼Œéœ€è¦åœ¨ Keycloak ä¸­é…ç½® GitLab å®¢æˆ·ç«¯ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç›®çš„æ˜¯åœ¨ GitLab ä¸­å¯ç”¨ Keycloak ç™»å½•ï¼Œé‚£ä¹ˆ Keycloak å°±æ˜¯ä¸€ä¸ª IDP äº†ï¼Œè€Œ GitLab æ˜¯å…¶ä¸€ä¸ª OAuth 2 å®¢æˆ·ç«¯åº”ç”¨ã€‚è¦å°† Keycloak å½“ä½œ IDPï¼Œä¸€èˆ¬æœ‰ä¸¤ç§å½¢å¼ï¼ŒOIDC å½¢å¼å’Œ SAML å½¢å¼ã€‚ 

ä½¿ç”¨ OIDC çš„å½¢å¼é›†æˆï¼Œæœ‰ä¸¤ç¯‡æ–‡ç« åšè¿‡è¯¦ç»†çš„ä»‹ç»ï¼š 

- ã€Š[ä½¿ç”¨ OIDC åœ¨ä¸€ä¸ª Keycloak ä¸­é›†æˆå¦ä¸€ä¸ª Keycloak ç”¨æˆ·è®¤è¯](https://zhuanlan.zhihu.com/p/360846976)ã€‹
- ã€Š[åœ¨ eggjs ä¸­é›†æˆ Keycloak ç”¨æˆ·è®¤è¯](https://zhuanlan.zhihu.com/p/359057316)ã€‹

å¦‚æœå¯¹è¿™ç§é›†æˆæ–¹å¼æ„Ÿå…´è¶£ï¼Œå¯ä»¥è¯¦ç»†å‚è€ƒã€‚è¿™é‡Œå‡†å¤‡**é‡‡ç”¨ SAML æ–¹å¼**é›†æˆï¼Œä»¥ä¾¿è¡¥å……è¿™ç§é›†æˆæ–¹å¼çš„å®æˆ˜ã€‚å®é™…ä¸Šï¼Œç½‘ä¸Šå·²ç»æœ‰ä¸€äº› GitLab å’Œ Keycloak é‡‡ç”¨ SAML é›†æˆçš„æ–‡ç« äº†ï¼Œä½†æ˜¯é‡‡ç”¨äº†éå¸¸å¤æ‚çš„æ–¹æ³•ï¼Œå› æ­¤æ•´ç¯‡æ–‡ç« éƒ½åœ¨è®²é›†æˆç»†èŠ‚ã€‚è¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ª**ç®€å•**çš„æ–¹å¼ï¼Œåªéœ€è¦ä¸€å°èŠ‚ä»‹ç»å³å¯ã€‚ 



### å¯¼å‡º GitLab çš„ SAML å…ƒæ•°æ® xml å®šä¹‰

- è¿™é‡Œå¡ä½äº†ï¼Œä¸çŸ¥é“æ€ä¹ˆå¯¼å‡ºsamlå…ƒæ•°æ®

å¯¹äºæ”¯æŒ SAML é›†æˆçš„åº”ç”¨ï¼Œå¯ä»¥è®¿é—®å…¶ `/users/auth/saml/metadata` è·å¾—å…¶ SAML æºæ•°æ®ä¿¡æ¯ã€‚å°†å…¶ä¿å­˜åˆ°æœ¬åœ°ï¼š 

![img](https://pic1.zhimg.com/80/v2-d3ac3a85274e69385917c9589c194ec4_1440w.jpg)

### åœ¨ Keycloak ä¸­æ·»åŠ  GitLab å®¢æˆ·ç«¯çš„ email æ˜ å°„

ä½ å¯ä»¥æ·»åŠ æ›´å¤šçš„æ˜ å°„ï¼Œä»¥ä¾¿æŠŠ Keycloak ä¸­çš„ç”¨æˆ·ä¿¡æ¯æ˜ å°„åˆ° GitLab ç³»ç»Ÿã€‚ä½†æ˜¯åªæœ‰ email æ˜¯å¿…é¡»çš„ã€‚ 



![img](https://pic1.zhimg.com/80/v2-0bb425c1ff40b389b9253538fbb26b10_1440w.jpg)



### é…ç½® GitLab



ç°åœ¨ï¼ŒKeycloak ä¸­å·²ç»æœ‰äº†æˆ‘ä»¬æ–°éƒ¨ç½²çš„ GitLab å®ä¾‹ä¿¡æ¯ï¼Œç°åœ¨éœ€è¦é…ç½® GitLabï¼Œè®©å®ƒçŸ¥é“æˆ‘ä»¬éƒ¨ç½²å¥½çš„ Keycloak å®ä¾‹ä¿¡æ¯ã€‚ 

é¦–å…ˆï¼Œéœ€è¦è®°ä¸‹ Keycloak åº”ç”¨å¯¹åº”çš„ Realm çš„ urlï¼Œä»¥åŠæ‹·è´ä¸€ä¸‹å®ƒçš„è¯ä¹¦ä¿¡æ¯ï¼š 



![img](https://pic2.zhimg.com/80/v2-8a787ee095d05c900703a1cf36bef3b9_1440w.jpg)



ç„¶åï¼Œå›åˆ° CodeSpacesï¼Œè¿›å…¥åˆ° GitLab docker é•œåƒé‡Œï¼š 

## gitlabä½¿ç”¨OIDCåè®®

## èƒŒæ™¯ï¼š

æœ€è¿‘æ”¶åˆ°å®¢æˆ·éœ€è¦æˆ‘ä»¬ dx-arch ç³»ç»Ÿå¯¹æ¥ä»–ä»¬çš„ sso ç³»ç»Ÿï¼Œ ä»–ä»¬çš„ sso ç³»ç»Ÿå¤§å¤šéƒ½æ˜¯åŸºäºoauth2 å†™çš„ã€‚ä½†æ˜¯keycloak åœ¨å¯¹æ¥ IDP çš„åè®®åªå£°æ˜äº†æ”¯æŒOIDC å’Œ SAML åè®®ï¼Œ

å…³äºOIDC ä¹‹å‰å·²ç»æœ‰æ–‡æ¡£æµ‹è¯•è¿‡äº†å¯¹æ¥ï¼Œæ€€ç€æµ‹è¯•çš„å¿ƒæƒ…æˆ‘æ‰“ç®—æ‰¾ä¸€ä¸ªæ”¯æŒoauth2 ç³»ç»Ÿçš„è¯•ä¸€è¯•keycloak æ˜¯å¦å¯ä»¥é€šè¿‡oauth2 å¯¹æ¥ç¬¬ä¸‰æ–¹ç³»ç»Ÿã€‚ ä½†æ˜¯æ‰¾äº†è®¸ä¹…çš„å¼€æºåŒ…æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„oauth2 server ï¼Œ

gitlab ä¹Ÿæ˜¯é€šè¿‡ oauth2 flow æ”¯æŒssoçš„ï¼Œ å› æ­¤å°±æ‰“ç®—ä½¿ç”¨gitlabæ¥è¯•ä¸€è¯•æ°´





## æ­å»ºgitlabï¼š

ç”±äºæœ¬æ¬¡æµ‹è¯•çš„é‡ç‚¹åœ¨keycloak å’Œgitlab oauth2 çš„å¯¹æ¥ï¼Œ æ‰€ä»¥è¿™é‡Œgitlab éƒ¨ç½²å°±æ˜¯ç®€å•é€šè¿‡docker è¿›è¡Œéƒ¨ç½²ã€‚

**éƒ¨ç½²gitlab** å±•å¼€æºç 

ç­‰å®¹å™¨å¯åŠ¨ä¹‹åéœ€è¦**ç­‰å¾…å‡ åˆ†é’Ÿ**è®©gitlab è·‘èµ·æ¥ã€‚ï¼ˆä¸è¦é—®æˆ‘ä¸ºå•¥åŠ ç²—æ ‡æ³¨ğŸ˜‚ï¼Œ å› ä¸ºæˆ‘ä¹‹å‰è€æ˜¯ä»¥ä¸ºæ˜¯æˆ‘å¯åŠ¨å§¿åŠ¿æœ‰é—®é¢˜ã€‚ çœ‹äº†åŠå¤©æ—¥å¿—æ²¡æŠ¥é”™ï¼Œç„¶åæ‰èµ·æ¥çš„ï¼Œ gitlabåœ¨å®¹å™¨å†…åšäº†ä¸€ç³»åˆ—è®¾ç½®æ‰€ä»¥å¯åŠ¨çš„æœ‰ç‚¹æ…¢ï¼Œå¦‚æœæœºå™¨å¡çš„è¯å¯èƒ½ä¼šæ›´æ…¢ä¸€ç‚¹ï¼‰



## é…ç½®gitlab

æ‰“å¼€ [http://10.6.165.11](http://10.6.165.11/) å³å¯çœ‹åˆ°è®¾ç½®å¯†ç çš„é¡µé¢ï¼Œ é»˜è®¤çš„è¶…çº§ç®¡ç†å‘˜çš„ç”¨æˆ·åæ˜¯ root è¿™é‡Œè®¾ç½®çš„å¯†ç å°±æ˜¯rootçš„å¯†ç 

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-18-4.png?version=1&modificationDate=1619579179373&api=v2)

è®¾ç½®å®Œå¯†ç ä¹‹åä¼šè¦æ±‚ç™»é™†ï¼Œä½¿ç”¨ç”¨æˆ·å root ä»¥åŠåˆšåˆšè®¾ç½®çš„å¯†ç  ç™»é™†

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-18-41.png?version=1&modificationDate=1619579179253&api=v2)

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-20-35.png?version=1&modificationDate=1619579179037&api=v2)

ç‚¹å‡»åˆ›å»ºapplication

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-22-30.png?version=1&modificationDate=1619579178874&api=v2)

å¡«å†™keycloak application ç›¸å…³å‚æ•°

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-25-45.png?version=1&modificationDate=1619579178610&api=v2)

è·å–application çš„ID å’Œsecret 

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-26-47.png?version=1&modificationDate=1619579178460&api=v2)





## é…ç½®keycloak

åœ¨keycloak ä¸­åˆ›å»ºIDPï¼ˆidentity Providersï¼‰ï¼Œ è¿™é‡Œé€‰æ‹©OIDC çš„åŸå› æ˜¯æ²¡æœ‰keycloakæ²¡æœ‰æä¾›oauth2çš„åè®®é€‰é¡¹ï¼Œ OIDCçš„æœ¬è´¨æµç¨‹å’Œoauthå¾ˆåƒ

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-28-35.png?version=1&modificationDate=1619579178253&api=v2)

åˆ›å»ºIDP

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-32-52.png?version=1&modificationDate=1619579177572&api=v2)

è®¾ç½®keycloak çš„ç™»é™†è®¾ç½®ï¼Œ éšè—å…¶è‡ªèº«çš„ç™»é™†é¡µé¢ã€‚

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-35-34.png?version=1&modificationDate=1619579177431&api=v2)

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-36-21.png?version=1&modificationDate=1619579177232&api=v2)





## æµ‹è¯•ç™»é™†ï¼š

å½“æˆ‘é€šè¿‡dx-arch è·³è½¬æ‰“å¼€keycloakç™»é™†é¡µé¢æ—¶å°±ä¼šç›´æ¥è·³è½¬åˆ°gilabçš„ç™»é™†é¡µé¢

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-47-32.png?version=1&modificationDate=1619579176973&api=v2)

å½“æ£€ç´¢åˆ°å½“å‰keycloakä¸­å·²ç»å­˜åœ¨æœ‰ç›¸å…³ä¿¡æ¯å†²çªçš„ç”¨æˆ·æˆ–è€…ä¸å­˜åœ¨å½“å‰çš„gitlabç”¨æˆ·æ—¶ä¼šè·³è½¬è®©ä½ æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œ keycloakä¼šé‡æ–°åœ¨keycloakä¸­åˆ›å»ºç”¨æˆ·å¹¶å…¥åº“ï¼Œ

ä¸”å½“gitlabç”¨æˆ·æ•°æ®å˜æ›´æ—¶ï¼Œç”¨æˆ·ä¸‹æ¬¡ç™»é™†æ˜¯ä¸ä¼šæ›´æ–°keycloakä¸­çš„ç”¨æˆ·æ•°æ®å’Œgitlabä¿æŒä¸€è‡´ï¼Œ éœ€è¦æ‰‹åŠ¨åœ¨keycloakä¸­æ›´æ”¹ç”¨æˆ·ä¿¡æ¯ã€‚

![img](https://dwiki.daocloud.io/download/attachments/84640566/image2020-9-15_17-51-3.png?version=1&modificationDate=1619579176720&api=v2)





## æ€»ç»“ï¼š

1. keycloak é€šè¿‡OIDC å¯¹æ¥ç¬¬ä¸‰æ–¹éœ€è¦å¡«å†™å¦‚ä¸‹ç›¸å…³å‚æ•°ï¼š
   1. client ID
   2. client Secret
   3. auth URL
   4. token URL
2. ä»¥ä¸Šå‚æ•°å‡æ˜¯oauth2ä¸­ç›¸å…³çš„å‚æ•°ï¼Œ OIDC åè®®æ˜¯æ‰©å……äº†Oauth2 çš„ä¸€äº›å‚æ•°ï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯èµ°çš„Oauth2çš„æµç¨‹ï¼Œ å› æ­¤ç†è®ºä¸Škeycloak å¯ä»¥å¯¹æ¥å®ç°äº†oauth2 çš„ç¬¬ä¸‰æ–¹sso serverã€‚ å¹¶ä¸”é€šè¿‡å¯ä»¥å¯¹æ¥gitlab ä¹Ÿå¯ä»¥ä½è¯è¿™ä¸€ç‚¹ã€‚











![image-20220525173012126](http://myimg.go2flare.xyz/img/image-20220525173012126.png)

![image-20220525173033989](http://myimg.go2flare.xyz/img/image-20220525173033989.png)

![image-20220525173049173](http://myimg.go2flare.xyz/img/image-20220525173049173.png)

![image-20220525173122620](http://myimg.go2flare.xyz/img/image-20220525173122620.png)

![image-20220525173357046](http://myimg.go2flare.xyz/img/image-20220525173357046.png)

![image-20220525173412834](http://myimg.go2flare.xyz/img/image-20220525173412834.png)







```

docker exec -it å®¹å™¨å /bin/bash
vi /etc/gitlab/gitlab.rb

```







## keycloakåšgitlab ssoå•ç‚¹ç™»å½•

### é¦–å…ˆéƒ¨ç½²gitlab--eeå®ä¾‹

gitlabæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œä¸€ä¸ªæ˜¯Gitlab-ceï¼ˆGitlab Community Editionï¼‰ï¼Œä¸€ä¸ªæ˜¯Gitlab-eeï¼ˆGitlab Enterprise Editionï¼‰

æœ¬æ–‡ä½¿ç”¨docker-composeçš„æ–¹å¼å®‰è£…gitlab-ee

- windows

```
services:
  web:
    image: 'gitlab/gitlab-ee:latest'
    restart: always
    hostname: 'localhost'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://localhost:8929' 
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      - '/c/doc_repo/gitlab-ee/etc/gitlab:/etc/gitlab'
      - '/c/doc_repo/gitlab-ee/var/log/gitlab:/var/log/gitlab'
      - '/c/doc_repo/gitlab-ee/var/opt/gitlab:/var/opt/gitlab'
```

- linux

```
services:
  web:
    image: 'gitlab/gitlab-ee:latest'
    restart: always
    hostname: '10.29.3.30'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://10.29.3.30:8929' 
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      - '/usr/local/pro_repo/doc_repo/gitlab-ee/etc/gitlab:/etc/gitlab'
      - '/usr/local/pro_repo/doc_repo/gitlab-ee/var/log/gitlab:/var/log/gitlab'
      - '/usr/local/pro_repo/doc_repo/gitlab-ee/var/opt/gitlab:/var/opt/gitlab'
```

> hostnameéœ€è¦æ›¿æ¢æˆå¯ä½¿ç”¨çš„endpointï¼Œå¦‚æœ¬åœ°çš„ç½‘å¡ipç­‰
>
> æŒ‚è½½çš„æ–‡ä»¶ç›®å½•éœ€è¦æ ¹æ®éœ€è¦è‡ªè¡Œè°ƒæ•´

```
docker compose up -d 
```

![image-20220527175722832](http://myimg.go2flare.xyz/img/image-20220527175722832.png)

çœ‹åˆ°å®¹å™¨å¦‚ä¸‹çŠ¶æ€ï¼Œå¦‚æœæ˜¯startingçŠ¶æ€åˆ™éœ€è¦ç­‰å¾…å‡ åˆ†é’Ÿ

```
healthï¼šstartingï¼ˆæ­£åœ¨å¯åŠ¨å®¹å™¨ï¼Œéœ€è€å¿ƒç­‰å¾…å‡ åˆ†é’Ÿï¼‰

healthyï¼ˆå®¹å™¨å·²å¯åŠ¨ï¼‰
```

![image-20220527175938429](http://myimg.go2flare.xyz/img/image-20220527175938429.png)

![image-20220527175815584](http://myimg.go2flare.xyz/img/image-20220527175815584.png)

å®¹å™¨å¯åŠ¨åï¼ŒæŒ‰é…ç½®ä¸­çš„endpointï¼ˆ10.29.3.30:8929ï¼‰ï¼Œå³å¯è®¿é—®å®¹å™¨å®ä¾‹çš„æœåŠ¡

é¦–æ¬¡ç™»å½•éœ€è¦ç”¨æˆ·çš„å¯†ç 

![image-20220527180140434](http://myimg.go2flare.xyz/img/image-20220527180140434.png)

åˆå§‹å¯†ç åœ¨å®¹å™¨å®ä¾‹çš„æ–‡ä»¶ä¸­ï¼Œè¿›å…¥åˆšéƒ¨ç½²çš„å®¹å™¨ä¸­ï¼ŒæŸ¥çœ‹åˆå§‹å¯†ç å¹¶å¤åˆ¶ï¼Œç™»å½•gitlabå**å°½å¿«ä¿®æ”¹å¯†ç **ï¼Œè¯¥æ–‡ä»¶ä¼šåœ¨24å°æ—¶å†…åˆ é™¤

```
# è¿›å…¥å®¹å™¨
docker exec -it gitlab-ee-web-1 /bin/bash
# æŸ¥çœ‹åˆå§‹å¯†ç 
cat /etc/gitlab/initial_root_password
```

![image-20220526112242428](http://myimg.go2flare.xyz/img/image-20220526112242428.png)

![image-20220526112409281](http://myimg.go2flare.xyz/img/image-20220526112409281.png)

### é…ç½®Keycloak

- clientè®¾ç½®

```
clients -> [gitlab] -> settings
```

![VeryCapture_20220529112637](http://myimg.go2flare.xyz/img/VeryCapture_20220529112637.jpg)

> Valid Redirect URLsï¼šgitlabé‡å®šå‘çš„åœ°å€
>
> BaseURLï¼škeycloakä¸­å¯è·³è½¬çš„clientçš„åœ°å€
>
> Master SAML Processing URLï¼šä¾›client Post ï¼ˆsign outç­‰ï¼‰çš„åœ°å€ï¼Ÿ
>
> IDP initiated SSO URL Nameï¼šåˆå§‹åŒ–clientçš„é‡å®šå‘åœ°å€åç§°ï¼Œæœ€å¥½å’Œclient IDä¸€è‡´

- client mapper

æ˜ å°„å™¨å°†ç”¨æˆ·ä¿¡æ¯æ˜ å°„åˆ° GitLab çš„ SAML 2.0è¯·æ±‚ä¸­çš„å‚æ•°ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªemailæ˜ å°„å™¨å°†keycloakä¸­çš„emailæ˜ å°„åˆ° Gitlabä¸­ï¼Œåœ¨gitlabåªæœ‰emailæ˜¯å¿…é¡»çš„

```
clients -> [gitlab] -> settings -> mappers
```

![image-20220527174123758](http://myimg.go2flare.xyz/img/image-20220527174123758.png)

![image-20220527174056310](http://myimg.go2flare.xyz/img/image-20220527174056310.png)

### é…ç½®GItlab

ç°åœ¨keycloakä¸­å·²ç»é…ç½®æœ‰Gitlabçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Gitlabä¸­é…ç½®Keycloakå®ä¾‹ä¿¡æ¯ï¼Œé¦–å…ˆè¿›å…¥Keycloakä¸­å¯¹åº”Gitlabçš„Realm Settingï¼Œå¤åˆ¶å…¶è¯ä¹¦ä¿¡æ¯

![image-20220526191439690](http://myimg.go2flare.xyz/img/image-20220526191439690.png)

æ‰“å¼€å®¿ä¸»æœºç›®å½•ä¸­çš„gitlab.rbæ–‡ä»¶

```
C:\doc_repo\gitlab-ee\etc\gitlab\gitlab.rb
```

![image-20220526115907402](http://myimg.go2flare.xyz/img/image-20220526115907402.png)

åœ¨gitlab.rbæ–‡ä»¶ä¸­é…ç½®keycloakæœ‰å…³ä¿¡æ¯ï¼Œé…ç½®ä¿¡æ¯å¦‚ä¸‹

```
gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['saml']
# gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'saml'
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_saml_user'] = true
gitlab_rails['omniauth_providers'] = [
    {
        name: 'saml',
        args: {
            assertion_consumer_service_url: '<gitlabå›è°ƒåœ°å€>/',
            idp_cert: " -----BEGIN CERTIFICATE-----
\n<YOUR CERTIFICATE>\n -----END CERTIFICATE----- \n",
            idp_sso_target_url: '<keycloaké‡å®šå‘åœ°å€>',
            issuer: '<gitlab>',
            name_identifier_format: 'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent'
        },
        label: 'KEYCLOAK ç™»å½•'
    }
]
```

å¯ä»¥ç›´æ¥åœ¨gitlab.rbæ–‡ä»¶ä¸­æœç´¢**OmniAuth Settingsé…ç½®å—**ï¼ŒæŒ‰éœ€ä¿®æ”¹é…ç½®å—ä¸­çš„å†…å®¹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨**æ–‡ä»¶æœ«å°¾é™„åŠ **é…ç½®ä¿¡æ¯

> gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'saml'ï¼šå¦‚æœä¸éœ€è¦gitlabçš„ç™»å½•ç•Œé¢ï¼Œé»˜è®¤ç”¨DX-ARCHçš„è¯åŠ ä¸Šè¯¥é€‰é¡¹
>
> gitlab_rails['omniauth_block_auto_created_users'] = falseï¼šä¸å…è®¸è‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼Œé€‰æ‹©falseå³å¯ä»¥é€šè¿‡keycloakè‡ªåŠ¨åˆ›å»ºgitlabç”¨æˆ·
>
> gitlab_rails['omniauth_auto_link_saml_user'] = trueï¼škeycloak userè‡ªåŠ¨é“¾æ¥åˆ°gitlabå·²æœ‰ç”¨æˆ·
>
> assertion_consumer_service_urlï¼šgitlabçš„å›è°ƒåœ°å€ï¼Œä¸€èˆ¬éƒ½ä¸ºå›ºå®š/users/auth/saml/callbackè·¯å¾„ï¼Œurlå‰é¢æ›´æ”¹ä¸ºä½ çš„gitlabåœ°å€
>
> idp_certï¼škeycloakä¸­realmçš„è¯ä¹¦ï¼Œå³ä¸Šä¸€æ­¥ä¸­å¤åˆ¶çš„è¯ä¹¦ä¿¡æ¯
>
> idp_sso_target_urlï¼šé‡å®šå‘keycloakåœ°å€ï¼Œå°†realmæ›¿æ¢ä¸ºä½ è®¾ç½®clientçš„realmï¼Œclientæ›¿æ¢ä¸ºè®¾ç½®çš„clientID
>
> issuerï¼škeycloakä¸­è®¾ç½®çš„Client ID

å®ä¾‹

```

gitlab_rails['omniauth_enabled'] = true
gitlab_rails['omniauth_allow_single_sign_on'] = ['saml']
# gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'saml'
gitlab_rails['omniauth_block_auto_created_users'] = false
gitlab_rails['omniauth_auto_link_saml_user'] = true
gitlab_rails['omniauth_providers'] = [
    {
        name: 'saml',
        args: {
            assertion_consumer_service_url: 'http://10.29.3.30:8929/users/auth/saml/callback',
            idp_cert: " -----BEGIN CERTIFICATE-----
\nMIIClzCCAX8CBgGA8IXOwjANBgkqhkiG9w0BAQsFADAPMQ0wCwYDVQQDDAR0ZXN0MB4XDTIyMDUyMzEwNDQwMloXDTMyMDUyMzEwNDU0MlowDzENMAsGA1UEAwwEdGVzdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAIAmQyDT06QqwNQzw24yGrOo0krHmxhWDOfoXbW+VskfhRcpdNbh3Q1y6hVfsEY50JhWcHPX3NUzG4xkztJ7JogtRDy082qAcR4Teg0Vj8iRV9tkU0SUAgxff+r2o3RErwy1IfONqHLLdGA8odScCX9jsa30IoIi9bujCwftUTvRux8JORL8HWSxxk2KyGUGsA1gcGa5TFiszetQBFFSWliMwt9xc2dv2Ss64v1866wrGfYvBjrq60KcCoNsJwCgQkUzl1ODHFD3YYNzSW0OprIqUlBaC4DVRXzyMiev99JwKhxgWb+e9naoDaGCU7WAMJ53KrLZx2U9OzWyNWA89RECAwEAATANBgkqhkiG9w0BAQsFAAOCAQEALr94VGV2ZP6e7TNeBYyEvdkxM0izzRTvgfUY9wwfQiIhSRKZMggdQ6GHqmxQxNWT/R5W+1j4nWDENFYFBcByA/SsXUM/xfpPcWVM2523BCqRs0Nlp6AIM06JT0WcFoKoM0cKNeEuxvGDQf8rffkfRDfI2DVw5jzvqVzqrYO+pEr1LlXqMXyLSTIcOt0qYIxdzCt50Bn0YToooYLCT+eFqU0JUpFI7E5NPybijGipUDxZt5lSM8S6KYEFQgwHG0fB5wIX6iiz3CI3bRETxe8DwEwSD79GMGZEzeSZKAqlk/ey8oAkFJV9opOxdkrW6+va1DJvQVE0VQU/CYJo/j9I9g==\n -----END CERTIFICATE----- \n",
            idp_sso_target_url: 'http://10.29.3.30:30035/auth/realms/test/protocol/saml/clients/http%3A%2F%2F10.29.3.30%3A8929',
            issuer: 'http://10.29.3.30:8929',
            name_identifier_format: 'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent'
        },
        label: 'DX-ARCH-TEST'
    }
]
```

ä¿®æ”¹å®Œå  **: wq** ä¿å­˜åé€€å‡ºé…ç½®æ–‡ä»¶ï¼Œé‡å¯Gitlabå®¹å™¨æˆ–è€…ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤é‡æ–°é…ç½®Gitlab

```
gitlab-ctl reconfigure
```

å°±å¯ä»¥åœ¨gitlabä¸­çœ‹åˆ°Keycloakçš„ç™»å½•å…¥å£äº†

![image-20220526191831794](http://myimg.go2flare.xyz/img/image-20220526191831794.png)

ç‚¹è¿›DX-ARCH

![image-20220527173508331](http://myimg.go2flare.xyz/img/image-20220527173508331.png)



> REF:
>
> [åœ¨è‡ªæ‰˜ç®¡ GitLab å®ä¾‹ä¸­é›†æˆ Keycloak ç™»å½• - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/405425214)
>
> [medium.com(éœ€ç¿»å¢™)](https://dheeruthedeployer.medium.com/gitlab-integration-with-keycloak-e1b2ff11a177#:~:text=STEP Create a SAML Client in Keycloak.,Replace the gitlab.server.com with your GitLab server name.)
>
> [ChathuminaVimukthi/Gitlab-SSO-implementation-using-Keycloak: Gitlab SSO implementation using Keycloak (github.com)](https://github.com/ChathuminaVimukthi/Gitlab-SSO-implementation-using-Keycloak)
>
> [gitlabç»Ÿä¸€ç™»å½•ä¸è·³è½¬ - å¹¿å·é¡¹ç›®ç®¡ç† - DaoCloud çŸ¥è¯†åº“](https://dwiki.daocloud.io/pages/viewpage.action?pageId=121164087)

### å¸¸è§é—®é¢˜

## gitlabé‡å®šå‘åˆ°keycloakæ˜¾ç¤ºpage not found

![image2022-5-29_15-45-30](http://myimg.go2flare.xyz/img/image2022-5-29_15-45-30.png)

### è§£å†³æ–¹å¼

**keycloakç‰ˆæœ¬è¾ƒæ–°**ï¼Œåœ¨gitlab.rbä¸­è®¾ç½®keycloakçš„é‡å®šå‘åœ°å€ä¸­æŠŠauthå»æ‰

![image2022-5-29_15-47-39](http://myimg.go2flare.xyz/img/image2022-5-29_15-47-39.png)

## gitlabé‡å®šå‘åˆ°keycloakæ˜¾ç¤ºclient not found

![image2022-5-29_15-54-46](http://myimg.go2flare.xyz/img/image2022-5-29_15-54-46.png)

### è§£å†³æ–¹å¼

åœ¨keycloakå’Œgitlabçš„é…ç½®ä¸­ç¡®å®šä»¥ä¸‹å‡ ä¸ªä½ç½®éƒ½**è®¾ç½®ä¸ºkeycloak çš„client ID**

![image2022-5-29_15-56-22](http://myimg.go2flare.xyz/img/image2022-5-29_15-56-22.png)



## keycloakåšgitlab ssoå•ç‚¹ç™»å½•ä½¿ç”¨OCIDåè®®

è¯¥æ–¹å¼éœ€è¦keycloaké‡‡ç”¨http2éƒ¨ç½²ï¼Œä¸”gitlabä¸­åŒ…å«æœ‰keycloakçš„è¯ä¹¦







> REF:
>
> [OpenID Connect OmniAuth provider |GitLab](https://docs.gitlab.com/ee/administration/auth/oidc.html#keycloak)
>
> [keycloaké›†æˆgitlab - åŒ—æ–¹å§†Q - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/bfmq/p/15917975.html)

![image-20220526140339746](http://myimg.go2flare.xyz/img/image-20220526140339746.png)

è¿™ä¸ªæ˜¯æœ€ç‹—çš„ä¸€ä¸ªé—®é¢˜ï¼Œä½†ä¸æ˜¯éƒ½ä¼šå‡ºç°ï¼Œè¿™ä¸ªæ˜¯httpsè¯ä¹¦çš„é—®é¢˜ã€‚ä½ çš„keycloakå¿…é¡»é…ç½®æˆhttpsçš„å¹¶ä¸”gitlabçš„æœåŠ¡å™¨è®¤è¿™ä¸ªè¯ä¹¦ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è‡ªç­¾è¯ä¹¦å°±éº»çƒ¦äº†ç‚¹ï¼Œå»ºè®®keycloakè·Ÿgitlabç”šè‡³æ‰€æœ‰æœåŠ¡éƒ½é…å¥½**åˆæ³•**è¯ä¹¦ï¼Œä¼šåœ¨æ— å½¢é—´è§£å†³æ— æ•°éº»çƒ¦

å®¹å™¨é‡Œçš„gitlabåŠ caè¯ä¹¦  cat /etc/gitlab/rootCA.pem >> /opt/gitlab/embedded/ssl/certs/cacert.pem && update-ca-certificates 

![img](https://img2022.cnblogs.com/blog/996591/202202/996591-20220221105233882-1418684821.png)

 

# K8Séƒ¨ç½²gitlab

## åˆ›å»ºnfså…±äº«æœåŠ¡å™¨

é€šè¿‡yumçš„æ–¹å¼è¿›è¡Œå®‰è£…

```
# å®‰è£…nfsæœåŠ¡
yum install nfs-utils
 
# å®‰è£…rpcæœåŠ¡
yum install rpcbind
 
# å…³äºå¼€æœºè‡ªå¯åŠ¨å‚è€ƒå®é™…æƒ…å†µè¿›è¡Œé…ç½®ï¼Œæ³¨æ„é˜²ç«å¢™å’Œiptableçš„é™åˆ¶
```

*æ¯”å¦‚è¿™é‡Œæˆ‘æƒ³ç›´æ¥å°†æ•´ä¸ªdataç”¨äºå­˜å‚¨ï¼Œé‚£æˆ‘å¯ä»¥ç›´æ¥ä½¿ç”¨å°±åœ°ä½¿ç”¨ï¼Œä½†æ³¨æ„æƒé™ï¼Œä¿®æ”¹æƒé™ä½¿ç”¨ `chmod 755`*

![img](https://dwiki.daocloud.io/download/attachments/103946596/image2021-12-4_2-14-21.png?version=1&modificationDate=1638555261546&api=v2)

*å¦‚æœæ˜¯æ–°ç›˜åˆ™éœ€è¦è¿›è¡Œæ ¼å¼åŒ–å’ŒæŒ‚è½½*

```
# å‡è®¾æœ‰å—ç›˜ä¸ºsdcï¼Œéœ€è¦å…ˆè¿›è¡Œæ ¼å¼åŒ–å¤„ç†
mkfs -t xfs /dev/sdc
 
# æŒ‚è½½åˆ°ç›®æ ‡æ–‡ä»¶å¤¹ä¸­
mount /dev/sdc /data
```



## 2ã€ä¿®æ”¹æ–‡ä»¶ /etc/exports

```
#åˆ›å»ºè¦å…±äº«çš„ç›®å½•
mkdir /data/redis -p
#è®¾ç½®æ–‡ä»¶å¤¹æƒé™å¦åˆ™å¯èƒ½å¯¼è‡´PVCåˆ›å»ºå¤±è´¥
chmod -R 777 /data/redis

#ç¼–è¾‘NFSé…ç½®å¹¶åŠ å…¥ä»¥ä¸‹å†…å®¹
vim /etc/exports
/data * (rw,sync,no_root_squash)
/data/postgresql/data * (rw,sync,no_root_squash)
/data/var/opt/gitlab/git-data * (rw,sync,no_root_squash)
/data/etc/gitlab * (rw,sync,no_root_squash)
/data/var/opt/gitlab/gitlab-rails/uploads * (rw,sync,no_root_squash)
/data/var/opt/gitlab/gitlab-rails/shared * (rw,sync,no_root_squash)
/data/var/opt/gitlab/gitlab-ci/builds * (rw,sync,no_root_squash)
/data/var/opt/gitlab * (rw,sync,no_root_squash)

#è½½å…¥é…ç½®
exportfs -rv
```

*å› ä¸ºä½¿ç”¨çš„æ˜¯dataç›®å½•ï¼ŒåŒæ—¶æ”¾è¡Œæ‰€æœ‰çš„IPï¼ˆè¿™ä¸ª\*å·å°±æ˜¯æ‰€æœ‰IPï¼Œå¦‚æœæˆ‘è¦è¿‡æ»¤192ï¼Œå°±å¯ä»¥å†™æˆ192.\*ï¼‰*

*å¹¶ä¸”è§„åˆ™è¦å¯è¯»å†™ï¼ˆrwï¼‰ï¼Œé¢‘ç¹é€šä¿¡ï¼ˆsyncåŒæ­¥æ›´æ–°ï¼‰ï¼Œno_root_squash(ç½‘é¡µæ‘˜æŠ„ï¼šç™»å…¥ NFS ä¸»æœºä½¿ç”¨åˆ†äº«ç›®å½•çš„ä½¿ç”¨è€…ï¼Œå¦‚æœæ˜¯ root çš„è¯ï¼Œé‚£ä¹ˆå¯¹äºè¿™ä¸ªåˆ†äº«çš„ç›®å½•æ¥è¯´ï¼Œä»–å°±å…·æœ‰ root çš„æƒé™ï¼‰*

![img](https://dwiki.daocloud.io/download/attachments/103946596/image2021-12-4_2-16-27.png?version=1&modificationDate=1638555387623&api=v2)



## 3ã€å¯åŠ¨å¿…è¦æœåŠ¡

```
# å…ˆå¯åŠ¨rpcbind
systemctl start rpcbind
 
# å†å¯åŠ¨nfs
systemctl start nfs-server
```

![img](https://dwiki.daocloud.io/download/attachments/103946596/image2021-12-4_2-26-28.png?version=1&modificationDate=1638555988942&api=v2)

å¯åŠ¨ä¹‹åå¯ä»¥ç”¨ä¸€äº›ç®€å•å‘½ä»¤æŸ¥çœ‹é…ç½®æ–‡ä»¶æ˜¯å¦æˆåŠŸ:

```
# NFSæœåŠ¡å™¨è‡ªå·±æŸ¥çœ‹
exportfs
 
# å…¶ä»–ä¸»æœºè®¿é—®è¯¥NFSæŸ¥çœ‹
showmount -e IP
```

![img](https://dwiki.daocloud.io/download/attachments/103946596/image2021-12-4_2-28-39.png?version=1&modificationDate=1638556120078&api=v2)

å½“å‡ºç°ä¸Šé¢çš„ç»“æœæ—¶è¡¨ç¤ºNFSæœåŠ¡å™¨å·²ç»å¥åº·è¿è¡Œ

## åˆ›å»ºpv

åˆ›å»ºPVCä¹‹åï¼Œåº”ç”¨å°±å¯ä»¥ä½¿ç”¨å­˜å‚¨äº†ï¼Œç›®å½•çš„æŒ‚è½½éƒ½å¯ä»¥åœ¨Podçš„ç¼–æ’ä¸­å£°æ˜ã€‚

PV(Persistent Volume)æ˜¯å¯¹åº•å±‚å­˜å‚¨çš„ä¸€å±‚æŠ½è±¡ï¼Œä»–å°†ä¸åŒå½¢å¼çš„å­˜å‚¨æŠ½è±¡ä¸ºç»Ÿä¸€çš„èµ„æºï¼ŒæŒ‰éœ€åˆ†é…ã€‚åŒæ—¶ï¼Œä»–å°†å­˜å‚¨ä¸­çš„ä¸€äº›å…³é”®ä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼‰ç»Ÿä¸€ç®¡ç†èµ·æ¥ï¼Œä½¿ç”¨å­˜å‚¨çš„åº”ç”¨åªéœ€å‘å…¶ç”³è¯·å³å¯ã€‚æ— éœ€å¡«å†™è¿™äº›ç§å¯†ä¿¡æ¯ã€‚

åœ¨DCEä¸­åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œè§†æƒ…å†µï¼Œä¿®æ”¹å­˜å‚¨å¤§å°ã€æŒ‚è½½ç›®å½•ï¼ŒNFSæœåŠ¡å™¨ipã€‚åˆ›å»ºä¹‹åéƒ¨ç½²å³å¯

```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: gitlab-nfs
  labels:
    type: gitlab-nfs
spec:
  capacity:
    storage: 10Gi
  accessModes:
    - ReadWriteMany # å¤šå®ä¾‹è¯»å†™
  nfs:
    path: /nfs-data/gitlab-data
    server: 10.29.0.122 # NFS Server
  persistentVolumeReclaimPolicy: Retain
  

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-claim
  labels:
    app: gitlab
spec:
  accessModes:
    - ReadWriteMany
  selector:
    matchLabels:
      type: gitlab-nfs
  resources:
    requests:
      storage: 10Gi
```

> nfs serverä¸çŸ¥é“æ€ä¹ˆæï¼Ÿçœ‹dceä¸Šåˆ«äººçš„serverå°±è¡Œå‘€

ä½¿ç”¨storage classæ–¹å¼è‡ªåŠ¨åˆ†é…å­˜å‚¨nfsï¼Œé›†ç¾¤ä¸­æœ¬èº«æœ‰å£°æ˜å¥½çš„storageclassï¼Œç›´æ¥ç”¨å³å¯

```
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-claim
  labels:
    app: gitlab
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
  storageClassName: daocloud-nfs
```



## åˆ›å»ºpvc

PVCï¼ˆPersistent Volume Chaimï¼‰æ˜¯ç”¨æˆ·å­˜å‚¨çš„è¯·æ±‚ã€‚ å®ƒç±»ä¼¼äºPodã€‚Podæ¶ˆè€—èŠ‚ç‚¹èµ„æºï¼ŒPVCæ¶ˆè€—å­˜å‚¨èµ„æºã€‚ Podå¯ä»¥è¯·æ±‚ç‰¹å®šçº§åˆ«çš„èµ„æºï¼ˆCPUå’Œå†…å­˜ï¼‰ã€‚ æƒé™è¦æ±‚å¯ä»¥è¯·æ±‚ç‰¹å®šçš„å¤§å°å’Œè®¿é—®æ¨¡å¼ã€‚

åœ¨åˆ›å»ºPVçš„åŸºç¡€ä¸Šï¼Œåˆ›å»ºPVCåˆ†é…ç»™ä¸åŒåº”ç”¨ä½¿ç”¨ã€‚åœ¨DCEé¡µé¢ä¸Šåˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œè§†æƒ…å†µä¿®æ”¹å­˜å‚¨å¤§å°ï¼Œä¹‹åç›´æ¥éƒ¨ç½²å³å¯

```

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: gitlab-claim
  labels:
    app: gitlab
spec:
  accessModes:
    - ReadWriteMany
  selector:
    matchLabels:
      type: gitlab-nfs
  resources:
    requests:
      storage: 950Gi
```



## redis

åœ¨DCEé¡µé¢åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œä¹‹åç›´æ¥ç‚¹å‡»éƒ¨ç½²åˆ°æŒ‡å®šç§Ÿæˆ·å³å¯ã€‚

```
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  labels:
    app: gitlab
spec:
  ports:
    - port: 6379
      targetPort: 6379
  selector:
    app: gitlab
    tier: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  labels:
    app: gitlab
    tier: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab
      tier: backend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: gitlab
        tier: backend
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: gitlab/middleware
                    operator: Exists
      tolerations:
        - key: gitlab/middleware
          effect: NoSchedule
      containers:
        - image: 10.29.3.30:30004/gitlab/redis:4.0.9-1
          name: redis
          resources:
            requests:
              cpu: 1
              memory: 1Gi
            limits:
              cpu: 1
              memory: 1Gi
          ports:
            - containerPort: 6379
              name: redis
          volumeMounts:
            - name: redis
              mountPath: /data
              subPath: redis
      volumes:
        - name: redis
          persistentVolumeClaim:
            claimName: gitlab-claim
```



## Postgresql

åœ¨DCEé¡µé¢åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œä¹‹åç›´æ¥ç‚¹å‡»éƒ¨ç½²åˆ°æŒ‡å®šç§Ÿæˆ·å³å¯ã€‚

```
apiVersion: v1
kind: Service
metadata:
  name: postgresql
  labels:
    app: gitlab
spec:
  ports:
    - port: 5432
  selector:
    app: gitlab
    tier: postgreSQL
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgresql
  labels:
    app: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab
      tier: postgreSQL
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: gitlab
        tier: postgreSQL
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: gitlab/middleware
                    operator: Exists
      tolerations:
        - key: gitlab/middleware
          effect: NoSchedule
      containers:
        - image: 10.29.3.30:30004/gitlab/postgresql:10
          name: postgresql
          resources:
            requests:
              cpu: 1
              memory: 2Gi
            limits:
              cpu: 1
              memory: 2Gi
          env:
            - name: POSTGRES_USER
              value: gitlab
            - name: POSTGRES_DB
              value: gitlabhq_production
            - name: POSTGRES_PASSWORD
              value: gitlab
          ports:
            - containerPort: 5432
              name: postgresql
          volumeMounts:
            - name: postgresql
              mountPath: /var/lib/postgresql/data
              subPath: postgre
      volumes:
        - name: postgresql
          persistentVolumeClaim:
            claimName: gitlab-claim
```

> ç™»å½•ï¼špsql -U postgres -h localhost
>
> åˆ›å»ºè§’è‰²ï¼š CREATE ROLE gitlab WITH LOGIN PASSWORD 'gitlab' SUPERUSER; # åˆ›å»ºåä¸º `gitlab` å¯†ç ä¸ºgitlabçš„role
>
> æŸ¥çœ‹è§’è‰²ï¼šselect rolname,rolsuper,rolcanlogin from pg_roles;
>
> åˆ›å»ºæ•°æ®åº“ï¼šcreate database gitlabhq_production;
>
> æŸ¥çœ‹æ•°æ®åº“ï¼š\list
>
> é€€å‡ºæ•°æ®åº“ï¼š\q
>

## GitLab Application Server

```
apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-cm
data:
  gitlab: |
    nginx['enable'] = false
    gitlab_rails['trusted_proxies'] = ['10.29.3.30']
    gitlab_workhorse['listen_network'] = "tcp"
    gitlab_workhorse['listen_addr'] = "0.0.0.0:9229"
    prometheus['enable'] = false
    alertmanager['enable'] = false
    grafana['enable'] = false
    postgresql['enable'] = false
    gitlab_rails['db_username'] = "gitlab"
    gitlab_rails['db_password'] = "gitlab"
    gitlab_rails['db_host'] = "postgresql"
    gitlab_rails['db_port'] = "5432"
    gitlab_rails['db_database'] = "gitlabhq_production"
    gitlab_rails['db_adapter'] = 'postgresql'
    gitlab_rails['db_encoding'] = 'utf8'
    redis['enable'] = false
    gitlab_rails['redis_host'] = 'redis'
    gitlab_rails['redis_port'] = '6379'
    gitlab_rails['gitlab_shell_ssh_port'] = 30022
    external_url 'http://10.29.3.30:10080'
    user['uid'] = 9000
    user['gid'] = 9000
    web_server['uid'] = 9001
    web_server['gid'] = 9001
    registry['uid'] = 9002
    registry['gid'] = 9002
    gitlab_rails['omniauth_enabled'] = true
    gitlab_rails['omniauth_allow_single_sign_on'] = ['saml']
    # gitlab_rails['omniauth_auto_sign_in_with_provider'] = 'saml'
    gitlab_rails['omniauth_block_auto_created_users'] = false
    gitlab_rails['omniauth_auto_link_saml_user'] = true
    gitlab_rails['omniauth_providers'] = [
        {
            name: 'saml',
            args: {
                assertion_consumer_service_url: 'http://10.29.3.30:10080/users/auth/saml/callback',
                idp_cert: " -----BEGIN CERTIFICATE-----
    \nMIIClzCCAX8CBgGA8IXOwjANBgkqhkiG9w0BAQsFADAPMQ0wCwYDVQQDDAR0ZXN0MB4XDTIyMDUyMzEwNDQwMloXDTMyMDUyMzEwNDU0MlowDzENMAsGA1UEAwwEdGVzdDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAIAmQyDT06QqwNQzw24yGrOo0krHmxhWDOfoXbW+VskfhRcpdNbh3Q1y6hVfsEY50JhWcHPX3NUzG4xkztJ7JogtRDy082qAcR4Teg0Vj8iRV9tkU0SUAgxff+r2o3RErwy1IfONqHLLdGA8odScCX9jsa30IoIi9bujCwftUTvRux8JORL8HWSxxk2KyGUGsA1gcGa5TFiszetQBFFSWliMwt9xc2dv2Ss64v1866wrGfYvBjrq60KcCoNsJwCgQkUzl1ODHFD3YYNzSW0OprIqUlBaC4DVRXzyMiev99JwKhxgWb+e9naoDaGCU7WAMJ53KrLZx2U9OzWyNWA89RECAwEAATANBgkqhkiG9w0BAQsFAAOCAQEALr94VGV2ZP6e7TNeBYyEvdkxM0izzRTvgfUY9wwfQiIhSRKZMggdQ6GHqmxQxNWT/R5W+1j4nWDENFYFBcByA/SsXUM/xfpPcWVM2523BCqRs0Nlp6AIM06JT0WcFoKoM0cKNeEuxvGDQf8rffkfRDfI2DVw5jzvqVzqrYO+pEr1LlXqMXyLSTIcOt0qYIxdzCt50Bn0YToooYLCT+eFqU0JUpFI7E5NPybijGipUDxZt5lSM8S6KYEFQgwHG0fB5wIX6iiz3CI3bRETxe8DwEwSD79GMGZEzeSZKAqlk/ey8oAkFJV9opOxdkrW6+va1DJvQVE0VQU/CYJo/j9I9g==\n -----END CERTIFICATE----- \n",
                     idp_sso_target_url: 'http://10.29.3.30:30035/auth/realms/test/protocol/saml/clients/gitlab',
                issuer: 'gitlab',
                name_identifier_format: 'urn:oasis:names:tc:SAML:2.0:nameid-format:persistent'
            },
            label: 'DX-ARCH'
        }
    ]

---
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  labels:
    app: gitlab
spec:
  ports:
    - name: gitlab-ui
      port: 9229
    - name: gitlab-ssh
      port: 22
  selector:
    app: gitlab
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  labels:
    app: gitlab
spec:
  replicas: 1
  selector:
    matchLabels:
      app: gitlab
      tier: frontend
  template:
    metadata:
      name: gitlab
      labels:
        app: gitlab
        tier: frontend
    spec:
      tolerations:
        - key: gitlab/application
          effect: NoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: gitlab/application
                    operator: Exists
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - gitlab
                  - key: tier
                    operator: In
                    values:
                      - frontend
              namespaces:
                - gitlab
              topologyKey: kubernetes.io/hostname
      containers:
        - image: 10.29.3.30:30004/gitlab/gitlab-ce:latest
          name: gitlab
          resources:
            limits:
              cpu: 1
              memory: 4Gi
            requests:
              cpu: 1
              memory: 4Gi
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: gitlab-cm
                  key: gitlab
          ports:
            - containerPort: 9229
              name: gitlab-ui
            - containerPort: 30022
              name: gitlab-ssh
          volumeMounts:
            - name: gitlab
              mountPath: /var/opt/gitlab/git-data
              subPath: gitlab-data/git-data
            - name: gitlab
              mountPath: /etc/gitlab
              subPath: gitlab-configuration
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/uploads
              subPath: gitlab-data/gitlab-rails/uploads
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/shared
              subPath: gitlab-data/gitlab-rails/shared
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-ci/builds
              subPath: gitlab-data/gitlab-ci/builds
            - name: gitlab
              mountPath: /var/opt/gitlab/.ssh
              subPath : gitlab-data/.ssh
      volumes:
        - name: gitlab
          persistentVolumeClaim:
            claimName: gitlab-claim

```



### é…ç½®æ–‡ä»¶

```
apiVersion: apps/v1
kind: ConfigMap
metadata:
  name: gitlab-cm
data:
  gitlab: |
    nginx['enable'] = false
    gitlab_rails['trusted_proxies'] = ['172.25.254.5']
    gitlab_workhorse['listen_network'] = "tcp"
    gitlab_workhorse['listen_addr'] = "0.0.0.0:9229"
    prometheus['enable'] = false
    alertmanager['enable'] = false
    grafana['enable'] = false
    postgresql['enable'] = false
    gitlab_rails['db_username'] = "gitlab"
    gitlab_rails['db_password'] = "gitlab"
    gitlab_rails['db_host'] = "postgresql"
    gitlab_rails['db_port'] = "5432"
    gitlab_rails['db_database'] = "gitlabhq_production"
    gitlab_rails['db_adapter'] = 'postgresql'
    gitlab_rails['db_encoding'] = 'utf8'
    redis['enable'] = false
    gitlab_rails['redis_host'] = 'redis'
    gitlab_rails['redis_port'] = '6379'
    gitlab_rails['gitlab_shell_ssh_port'] = 30022
    external_url 'http://172.25.254.5:10080'
    user['uid'] = 9000
    user['gid'] = 9000
    web_server['uid'] = 9001
    web_server['gid'] = 9001
    registry['uid'] = 9002
    registry['gid'] = 9002
    gitlab_rails['omniauth_allow_single_sign_on'] = ['github']
    gitlab_rails['omniauth_providers'] = [
      {
        "name" => "github",
        "app_id" => "ea4146f6f57b1011d3d5",
        "app_secret" => "b3eeea887c5f37460b0db1da4eaa88652288d2ec",
        "url" => "http://git.gtmc.com.cn/",
        "args" => { "scope" => "user:email" }
      }
    ]
```



### åˆå§‹åŒ–Job

åœ¨DCEä¸­åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œè§†æƒ…å†µï¼Œä¿®æ”¹å¤–éƒ¨nginxåœ°å€ã€‚åˆ›å»ºä¹‹åéƒ¨ç½²å³å¯

```
---
apiVersion: batch/v1
kind: Job
metadata:
  name: gitlab-init
spec:
  template:
    metadata:
      name: gitlab-init
    spec:
      restartPolicy: Never
      tolerations:
        - key: gitlab/application
          effect: NoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: gitlab/application
                    operator: Exists
      containers:
        - image: 10.29.3.30:30004/gitlab/gitlab-ce:latest
          command: ["/bin/bash"]
          args: ["-c", "/assets/wrapper; touch /etc/gitlab/skip-auto-reconfigure"]
          name: install
          resources:
            limits:
              cpu: 0.5
              memory: 0.5Gi
            requests:
              cpu: 0.5
              memory: 0.5Gi
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: gitlab-cm
                  key: gitlab
          volumeMounts:
            - name: gitlab
              mountPath: /var/opt/gitlab/git-data
              subPath: gitlab-data/git-data
            - name: gitlab
              mountPath: /etc/gitlab
              subPath: gitlab-configuration
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/uploads
              subPath: gitlab-data/gitlab-rails/uploads
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/shared
              subPath: gitlab-data/gitlab-rails/shared
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-ci/builds
              subPath: gitlab-data/gitlab-ci/builds
            - name: gitlab
              mountPath: /var/opt/gitlab/.ssh
              subPath : gitlab-data/.ssh
      volumes:
        - name: gitlab
          persistentVolumeClaim:
            claimName: gitlab-claim
```

```
+    # Trusted Proxies
      +    # Customize if you have GitLab behind a reverse proxy which is running on a different machine.
      +    # Add the IP address for your reverse proxy to the list, otherwise users will appear signed in from that address.
      å¦‚æœæ‚¨åœ¨å¦ä¸€å°æœºå™¨ä¸Šè¿è¡Œçš„åå‘ä»£ç†åé¢æœ‰ GitLabï¼Œè¯·è‡ªå®šä¹‰ã€‚å°†åå‘ä»£ç†çš„ IP åœ°å€æ·»åŠ åˆ°åˆ—è¡¨ä¸­ï¼Œå¦åˆ™ç”¨æˆ·å°†æ˜¾ç¤ºä»è¯¥åœ°å€ç™»å½•ã€‚

```



### Deployment

åœ¨DCEä¸­åˆ›å»ºåº”ç”¨æ¨¡æ¿ï¼Œå¡«å†™ä»¥ä¸‹ç¼–æ’ï¼Œè§†æƒ…å†µï¼Œä¿®æ”¹å¤–éƒ¨nginxåœ°å€ã€‚åˆ›å»ºä¹‹åéƒ¨ç½²å³å¯ï¼Œå®ŒæˆGitLabåº”ç”¨çš„éƒ¨ç½²ã€‚

```
---
apiVersion: v1
kind: Service
metadata:
  name: gitlab
  labels:
    app: gitlab
spec:
  ports:
    - name: gitlab-ui
      port: 9229
    - name: gitlab-ssh
      port: 22
  selector:
    app: gitlab
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gitlab
  labels:
    app: gitlab
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gitlab
      tier: frontend
  template:
    metadata:
      name: gitlab
      labels:
        app: gitlab
        tier: frontend
    spec:
      tolerations:
        - key: gitlab/application
          effect: NoSchedule
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: gitlab/application
                    operator: Exists
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - gitlab
                  - key: tier
                    operator: In
                    values:
                      - frontend
              namespaces:
                - gitlab
              topologyKey: kubernetes.io/hostname
      containers:
        - image: 192.168.110.253/gitlab/gitlab-ce:12.4.1-ce.0
          name: gitlab
          resources:
            limits:
              cpu: 4
              memory: 16Gi
            requests:
              cpu: 4
              memory: 16Gi
          env:
            - name: GITLAB_OMNIBUS_CONFIG
              valueFrom:
                configMapKeyRef:
                  name: gitlab-cm
                  key: gitlab
          ports:
            - containerPort: 9229
              name: gitlab-ui
            - containerPort: 30022
              name: gitlab-ssh
          volumeMounts:
            - name: gitlab
              mountPath: /var/opt/gitlab/git-data
              subPath: gitlab-data/git-data
            - name: gitlab
              mountPath: /etc/gitlab
              subPath: gitlab-configuration
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/uploads
              subPath: gitlab-data/gitlab-rails/uploads
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-rails/shared
              subPath: gitlab-data/gitlab-rails/shared
            - name: gitlab
              mountPath: /var/opt/gitlab/gitlab-ci/builds
              subPath: gitlab-data/gitlab-ci/builds
            - name: gitlab
              mountPath: /var/opt/gitlab/.ssh
              subPath : gitlab-data/.ssh
      volumes:
        - name: gitlab
          persistentVolumeClaim:
            claimName: gitlab-claim
```

```
è¿™é‡Œçš„external_urlæŒ‡çš„æ˜¯ï¼šgitlabä¸­é¡¹ç›®é‡Œï¼Œclone é¡¹ç›®åœ°å€æ—¶å‰ç¼€æ‰€ä½¿ç”¨çš„url
```

![image-20220601005002766](http://myimg.go2flare.xyz/img/image-20220601005002766.png)

![image-20220601005246387](http://myimg.go2flare.xyz/img/image-20220601005246387.png)

# å¸¸è§é—®é¢˜

## é‡åˆ°çš„é—®é¢˜

gitlabçš„æ—¥å¿—ä¸­æœ‰é‡è¦çš„å†…å®¹ï¼š You are using PostgreSQL 10.4 for the main database, but PostgreSQL >= 12
  is required for this version of GitLab. æé†’äº†postgreSQLç‰ˆæœ¬è¿‡ä½ï¼Œéœ€è¦æ›´æ–°ä¸‹ç‰ˆæœ¬åˆ°12ä»¥ä¸Šã€‚

```
Running handlers:

Notes:
Default admin account has been configured with following details:
Username: root
Password: You didn't opt-in to print initial root password to STDOUT.
Password stored to /etc/gitlab/initial_root_password. This file will be cleaned up in first reconfigure run after 24 hours.

NOTE: Because these credentials might be present in your log files in plain text, it is highly recommended to reset the password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.

Running handlers complete
There was an error running gitlab-ctl reconfigure:

rails_migration[gitlab-rails] (gitlab::database_migrations line 51) had an error: Mixlib::ShellOut::ShellCommandFailed: bash[migrate g 	tlab-rails database] (/opt/gitlab/embedded/cookbooks/cache/cookbooks/gitlab/resources/rails_migration.rb line 16) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'
---- Begin output of "bash"  "/tmp/chef-script20220601-27-1nqtzjm" ----
STDOUT: â–ˆâ–ˆâ€    â–ˆâ–ˆâ€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€ â–ˆâ–ˆâ–ˆâ€   â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ€   â–ˆâ–ˆâ€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€
          â–ˆâ–ˆâ€    â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ–ˆâ€  â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ–ˆâ€  â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â€â€â€â€
          â–ˆâ–ˆâ€ â–ˆâ€ â–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€ â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€ â–ˆâ–ˆâ€â–ˆâ–ˆâ€  â–ˆâ–ˆâ–ˆâ€
          â–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â€â–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€   â–ˆâ–ˆâ€
          â€â–ˆâ–ˆâ–ˆâ€â–ˆâ–ˆâ–ˆâ€â€â–ˆâ–ˆâ€  â–ˆâ–ˆâ€â–ˆâ–ˆâ€  â–ˆâ–ˆâ€â–ˆâ–ˆâ€ â€â–ˆâ–ˆâ–ˆâ–ˆâ€â–ˆâ–ˆâ€â–ˆâ–ˆâ€ â€â–ˆâ–ˆâ–ˆâ–ˆâ€â€â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ€â€

******************************************************************************
  You are using PostgreSQL 10.4 for the main database, but PostgreSQL >= 12
  is required for this version of GitLab.
  
  Please upgrade your environment to a supported PostgreSQL version, see
  https://docs.gitlab.com/ee/install/requirements.html#database for details.
******************************************************************************
psql:/opt/gitlab/embedded/service/gitlab-rails/db/structure.sql:203: ERROR:  unrecognized partitioning strategy "hash"
rake aborted!
failed to execute:
psql --set ON_ERROR_STOP=1 --quiet --no-psqlrc --file /opt/gitlab/embedded/service/gitlab-rails/db/structure.sql --single-transaction gitlabhq_production

Please check the output above for any errors and make sure that `psql` is installed in your PATH and has proper permissions.

/opt/gitlab/embedded/service/gitlab-rails/lib/gitlab/database/postgresql_database_tasks/load_schema_versions_mixin.rb:10:in `structure_load'
/opt/gitlab/embedded/service/gitlab-rails/lib/tasks/gitlab/db.rake:67:in `block (3 levels) in <top (required)>'
/opt/gitlab/embedded/bin/bundle:23:in `load'
/opt/gitlab/embedded/bin/bundle:23:in `<main>'
Tasks: TOP => db:schema:load
(See full trace by running task with --trace)
STDERR: 
---- End output of "bash"  "/tmp/chef-script20220601-27-1nqtzjm" ----
Ran "bash"  "/tmp/chef-script20220601-27-1nqtzjm" returned 1

Chef Infra Client failed. 140 resources updated in 01 minutes 48 seconds

Notes:
Default admin account has been configured with following details:
Username: root
Password: You didn't opt-in to print initial root password to STDOUT.
Password stored to /etc/gitlab/initial_root_password. This file will be cleaned up in first reconfigure run after 24 hours.

NOTE: Because these credentials might be present in your log files in plain text, it is highly recommended to reset the password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.
```

![image-20220601114715953](http://myimg.go2flare.xyz/img/image-20220601114715953.png)

![image-20220601114730996](http://myimg.go2flare.xyz/img/image-20220601114730996.png)

![image-20220601142718449](http://myimg.go2flare.xyz/img/image-20220601142718449.png)

```
# WARNING: This value is valid only in the following conditions
#          1. If provided manually (either via `GITLAB_ROOT_PASSWORD` environment variable or via `gitlab_rails['initial_root_password']` setting in `gitlab.rb`, it was provided before database was seeded for the first time (usually, the first reconfigure run).
#          2. Password hasn't been changed manually, either via UI or via command line.
#
#          If the password shown here doesn't work, you must reset the admin password following https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password.

Password: GSdr8GqMTeFkob3To7I5UaZx+bXmE9hINj3UMuWCg9w=

# NOTE: This file will be automatically deleted in the first reconfigure run after 24 hours.++
```

## åˆå§‹å¯†ç æ— æ³•ç™»å½•

é‡ç½®gitlabçš„ç™»å½•å¯†ç æ­¥éª¤ï¼š
1ã€è·å–å®¹å™¨çš„idæˆ–è€…åˆ«å

```shell
#å®¹å™¨éƒ¨ç½²
docker ps

#é›†ç¾¤éƒ¨ç½²
k get pod -n gitlab
```

2ã€è¿›å…¥å®¹å™¨

```shell
#gitlabä¸ºä¸€å¼€å§‹è®¾ç½®çš„å®¹å™¨åˆ«åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®¹å™¨id
#å®¹å™¨éƒ¨ç½²
docker exec -it gitlab bash

#é›†ç¾¤éƒ¨ç½²
k exec -it gitlab -n gitlab -- bash
```

3ã€å¯åŠ¨Railsæ§åˆ¶å°

```shell
gitlab-rails console -e production
```



ç­‰å¾…æ‰§è¡Œå®Œï¼Œä¼šè¿›å…¥è¾“å…¥æ¨¡å¼
4ã€è·å–ç”¨æˆ·ï¼Œè®¾ç½®å¯†ç 

```shell
//ç¬¬ä¸€ä¸ªé»˜è®¤ä¸ºroot
user = User.where(id: 1).first
//å¿…é¡»åŒæ—¶æ›´æ”¹å¯†ç å’Œpassword_confirmationæ‰èƒ½ä½¿å…¶æ­£å¸¸å·¥ä½œ
user.password = 'æ–°çš„å¯†ç '
user.password_confirmation = 'æ–°çš„å¯†ç '
```

5ã€ä¿å­˜

```shell
//ä¿å­˜ï¼Œç¨ç­‰ä¸€ä¼šå°±ä¼šæ‰§è¡Œåˆšæ‰è¾“å…¥çš„ä»£ç 
user.save!
```


6ã€é€€å‡ºå®¹å™¨

```shell
ctrl+d
```

![image-20220608171306546](http://myimg.go2flare.xyz/img/image-20220608171306546.png)

ç„¶åå°±å¯ä»¥ä½¿ç”¨åˆšæ‰è¾“å…¥çš„å¯†ç ç™»å½•rootè´¦å·äº†
